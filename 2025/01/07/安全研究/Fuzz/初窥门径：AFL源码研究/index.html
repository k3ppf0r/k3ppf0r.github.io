

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/tab-about/red_bear.jpg">
  <link rel="icon" href="/img/tab-about/red_bear.jpg">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="k3ppf0r">
  <meta name="keywords" content="安全研究,AFL,源码">
  
    <meta name="description" content="AFL 源码解释与研究一">
<meta property="og:type" content="article">
<meta property="og:title" content="初窥 fuzz 门径：AFL源码研究">
<meta property="og:url" content="https://k3ppf0r.github.io/2025/01/07/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/Fuzz/%E5%88%9D%E7%AA%A5%E9%97%A8%E5%BE%84%EF%BC%9AAFL%E6%BA%90%E7%A0%81%E7%A0%94%E7%A9%B6/index.html">
<meta property="og:site_name" content="k3ppf0r&#39;s blog">
<meta property="og:description" content="AFL 源码解释与研究一">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://k3ppf0r.github.io/img/post-%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/afl.png">
<meta property="article:published_time" content="2025-01-07T09:00:00.000Z">
<meta property="article:modified_time" content="2025-01-08T04:00:00.000Z">
<meta property="article:author" content="k3ppf0r">
<meta property="article:tag" content="安全研究">
<meta property="article:tag" content="AFL">
<meta property="article:tag" content="源码">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://k3ppf0r.github.io/img/post-%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/afl.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>初窥 fuzz 门径：AFL源码研究 - k3ppf0r&#39;s blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/prism/1.28.0/plugins/line-numbers/prism-line-numbers.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"k3ppf0r.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":2},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null},"gtag":null,"woyaola":null,"cnzz":null},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  



  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>k3ppf0r&#39;s blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/" target="_self">
                <i class="iconfont icon-link-fill"></i>
                <span>友链</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/0-post-default/post.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="初窥 fuzz 门径：AFL源码研究"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-01-07 17:00" pubdate>
          2025年1月7日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          6.7k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          56 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        

      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">初窥 fuzz 门径：AFL源码研究</h1>
            
              <p id="updated-time" class="note note-info" style="">
                
                  
                    本文最后更新于 2025年1月8日 中午
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <p>AFL, 作为fuzz类工具的开山鼻祖，笔者认为对于其源码十分有研究的价值。本文即是记录笔者在阅读AFL源码过程中对于重点和大体流程的解读与理解。可能存在个人理解上的错误，欢迎指正。</p>
<p>源码批注版项目：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-git" data-language="git"><code class="language-git">https://github.com/k3ppf0r/AFL<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<h1 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h1><p><img src="/2025/01/07/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/Fuzz/%E5%88%9D%E7%AA%A5%E9%97%A8%E5%BE%84%EF%BC%9AAFL%E6%BA%90%E7%A0%81%E7%A0%94%E7%A9%B6/%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84.png" srcset="/img/loading.gif" lazyload alt="项目结构"></p>
<p>重点需要关注AFL 的根目录下<code>afl-fuzz.c</code>、<code>afl-gcc.c</code>、<code>afl-tmin.c</code> 等核心程序的实现上，独立功能<code>llvm_mode</code>、<code>qemu_mode</code>被放在单独的文件夹中，其中<code>afl-fuzz.c</code> 是项目核心，代码量有 8k 行左右。</p>
<p>项目模块主要功能：</p>
<ul>
<li><p>插桩模块<br>插桩模块负责在目标程序中插入代码以收集执行路径的信息，这是 AFL 实现模糊测试的基础。AFL 提供了多种插桩模式，以适应不同的编译环境和需求：</p>
<ul>
<li>源码级插桩：通过 <code>afl-as.h</code>, <code>afl-as.c</code> 和 <code>afl-gcc.c</code> 文件实现，针对源码插桩，编译器可以使用 gcc， clang；</li>
<li>LLVM 插桩模式：由 <code>llvm_mode</code> 目录下的文件提供支持，llvm 插桩模式，针对源码插桩，编译器使用 clang；</li>
<li>QEMU 插桩模式：通过 <code>qemu_mode</code> 模块实现，针对二进制文件进行插桩，无需源代码即可对已编译的应用程序进行模糊测试。</li>
</ul>
</li>
<li><p>Fuzzer 模块<br>核心模糊测试逻辑由 <code>afl-fuzz.c</code> 文件中的代码实现，它是 AFL 的主体部分，负责管理和驱动整个模糊测试过程，包括生成输入、监控程序行为以及基于反馈调整未来的测试用例。</p>
</li>
<li><p>辅助工具模块<br>AFL 还配备了一系列辅助工具，用于增强模糊测试的效果和分析能力：</p>
<ul>
<li><code>afl-analyze</code>：分析给定的测试用例，帮助识别有意义的数据字段</li>
<li><code>afl-plot</code>：生成图表来可视化模糊测试的状态和进度</li>
<li><code>afl-tmin</code>：对测试用例进行最小化处理，去除不必要的部分，使得测试用例尽可能简洁且有效</li>
<li><code>afl-cmin</code>：对语料库进行精简，保留最具代表性的样本，减少冗余并优化后续的模糊测试效率</li>
<li><code>afl-showmap</code>：跟踪单个测试用例的执行路径，显示程序执行过程中触发的基本块覆盖情况</li>
<li><code>afl-whatsup</code>：汇总并行运行的多个模糊测试实例的结果</li>
<li><code>afl-gotcpu</code>：检查当前系统的 CPU 使用状态</li>
</ul>
</li>
<li><p>头文件说明<br>为了支持上述功能的实现，AFL 依赖于一些关键头文件：</p>
<ul>
<li><code>alloc-inl.h</code>：定义了带有检测功能的内存分配和释放操作</li>
<li><code>config.h</code>：包含配置选项的定义</li>
<li><code>debug.h</code>：提供了与调试信息相关的宏定义</li>
<li><code>hash.h</code>：实现了哈希函数</li>
<li><code>types.h</code>：定义了一些常用的数据类型和宏</li>
</ul>
</li>
</ul>
<p>查看项目的Makefile,可以看到相关生成的目标文件的命名细节和配置细节：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-makefile" data-language="makefile"><code class="language-makefile">
PROGNAME    <span class="token operator">=</span> afl
<span class="token comment"># #不需要转义，但能working. e.g. echo '#define VERSION "2.57b"' | grep '^\#\d\efine VERSION '</span>
VERSION     <span class="token operator">=</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">shell</span> grep <span class="token string">'^\#define VERSION '</span> config.h <span class="token operator">|</span> cut -d <span class="token string">'"'</span> -f2<span class="token punctuation">)</span>

PREFIX     <span class="token operator">?=</span> /usr/local
BIN_PATH    <span class="token operator">=</span> <span class="token variable">$</span><span class="token punctuation">(</span>PREFIX<span class="token punctuation">)</span>/bin
HELPER_PATH <span class="token operator">=</span> <span class="token variable">$</span><span class="token punctuation">(</span>PREFIX<span class="token punctuation">)</span>/lib/afl
DOC_PATH    <span class="token operator">=</span> <span class="token variable">$</span><span class="token punctuation">(</span>PREFIX<span class="token punctuation">)</span>/share/doc/afl
MISC_PATH   <span class="token operator">=</span> <span class="token variable">$</span><span class="token punctuation">(</span>PREFIX<span class="token punctuation">)</span>/share/afl

<span class="token comment"># PROGS intentionally omit afl-as, which gets installed elsewhere.</span>

PROGS       <span class="token operator">=</span> afl-gcc afl-fuzz afl-showmap afl-tmin afl-gotcpu afl-analyze
SH_PROGS    <span class="token operator">=</span> afl-plot afl-cmin afl-whatsup

CFLAGS     <span class="token operator">?=</span> -O3 -funroll-loops
CFLAGS     <span class="token operator">+=</span> -Wall -D_FORTIFY_SOURCE<span class="token operator">=</span>2 -g -Wno-pointer-sign \
	      -DAFL_PATH<span class="token operator">=</span>\"<span class="token variable">$</span><span class="token punctuation">(</span>HELPER_PATH<span class="token punctuation">)</span>\" -DDOC_PATH<span class="token operator">=</span>\"<span class="token variable">$</span><span class="token punctuation">(</span>DOC_PATH<span class="token punctuation">)</span>\" \
	      -DBIN_PATH<span class="token operator">=</span>\"<span class="token variable">$</span><span class="token punctuation">(</span>BIN_PATH<span class="token punctuation">)</span>\"

<span class="token keyword">ifneq</span> <span class="token string">"$(filter Linux GNU%,$(shell uname))"</span> <span class="token string">""</span>
  LDFLAGS  <span class="token operator">+=</span> -ldl
<span class="token keyword">endif</span>

<span class="token keyword">ifeq</span> <span class="token string">"$(findstring clang, $(shell $(CC) --version 2>/dev/null))"</span> <span class="token string">""</span>
  TEST_CC   <span class="token operator">=</span> afl-gcc
<span class="token keyword">else</span>
  TEST_CC   <span class="token operator">=</span> afl-clang
<span class="token keyword">endif</span>

COMM_HDR    <span class="token operator">=</span> alloc-inl.h config.h debug.h types.h

<span class="token target symbol">all</span><span class="token punctuation">:</span> test_x86 <span class="token variable">$</span><span class="token punctuation">(</span>PROGS<span class="token punctuation">)</span> afl-as test_build all_done

<span class="token keyword">ifndef</span> AFL_NO_X86

<span class="token target symbol">test_x86</span><span class="token punctuation">:</span>
	<span class="token operator">@</span>echo <span class="token string">"[*] Checking for the ability to compile x86 code..."</span>
	<span class="token operator">@</span>echo <span class="token string">'main() &#123; __asm__("xorb %al, %al"); &#125;'</span> <span class="token operator">|</span> <span class="token variable">$</span><span class="token punctuation">(</span>CC<span class="token punctuation">)</span> -w -x c - -o .test <span class="token operator">|</span><span class="token operator">|</span> <span class="token punctuation">(</span> echo<span class="token punctuation">;</span> echo <span class="token string">"Oops, looks like your compiler can't generate x86 code."</span><span class="token punctuation">;</span> echo<span class="token punctuation">;</span> echo <span class="token string">"Don't panic! You can use the LLVM or QEMU mode, but see docs/INSTALL first."</span><span class="token punctuation">;</span> echo <span class="token string">"(To ignore this error, set AFL_NO_X86=1 and try again.)"</span><span class="token punctuation">;</span> echo<span class="token punctuation">;</span> exit 1 <span class="token punctuation">)</span>
	<span class="token operator">@</span>rm -f .test
	<span class="token operator">@</span>echo <span class="token string">"[+] Everything seems to be working, ready to compile."</span>

<span class="token keyword">else</span>

<span class="token target symbol">test_x86</span><span class="token punctuation">:</span>
	<span class="token operator">@</span>echo <span class="token string">"[!] Note: skipping x86 compilation checks (AFL_NO_X86 set)."</span>

<span class="token keyword">endif</span>

<span class="token target symbol">afl-gcc</span><span class="token punctuation">:</span> afl-gcc.c <span class="token variable">$</span><span class="token punctuation">(</span>COMM_HDR<span class="token punctuation">)</span> <span class="token operator">|</span> test_x86
	<span class="token variable">$</span><span class="token punctuation">(</span>CC<span class="token punctuation">)</span> <span class="token variable">$</span><span class="token punctuation">(</span>CFLAGS<span class="token punctuation">)</span> <span class="token variable">$@.c</span> -o <span class="token variable">$@</span> <span class="token variable">$</span><span class="token punctuation">(</span>LDFLAGS<span class="token punctuation">)</span>
	set -e<span class="token punctuation">;</span> for i in afl-g++ afl-clang afl-clang++<span class="token punctuation">;</span> do ln -sf afl-gcc <span class="token variable">$$i;</span> done

<span class="token target symbol">afl-as</span><span class="token punctuation">:</span> afl-as.c afl-as.h <span class="token variable">$</span><span class="token punctuation">(</span>COMM_HDR<span class="token punctuation">)</span> <span class="token operator">|</span> test_x86
	<span class="token variable">$</span><span class="token punctuation">(</span>CC<span class="token punctuation">)</span> <span class="token variable">$</span><span class="token punctuation">(</span>CFLAGS<span class="token punctuation">)</span> <span class="token variable">$@.c</span> -o <span class="token variable">$@</span> <span class="token variable">$</span><span class="token punctuation">(</span>LDFLAGS<span class="token punctuation">)</span>
	ln -sf afl-as as

<span class="token target symbol">afl-fuzz</span><span class="token punctuation">:</span> afl-fuzz.c <span class="token variable">$</span><span class="token punctuation">(</span>COMM_HDR<span class="token punctuation">)</span> <span class="token operator">|</span> test_x86
	<span class="token variable">$</span><span class="token punctuation">(</span>CC<span class="token punctuation">)</span> <span class="token variable">$</span><span class="token punctuation">(</span>CFLAGS<span class="token punctuation">)</span> <span class="token variable">$@.c</span> -o <span class="token variable">$@</span> <span class="token variable">$</span><span class="token punctuation">(</span>LDFLAGS<span class="token punctuation">)</span>

<span class="token target symbol">afl-showmap</span><span class="token punctuation">:</span> afl-showmap.c <span class="token variable">$</span><span class="token punctuation">(</span>COMM_HDR<span class="token punctuation">)</span> <span class="token operator">|</span> test_x86
	<span class="token variable">$</span><span class="token punctuation">(</span>CC<span class="token punctuation">)</span> <span class="token variable">$</span><span class="token punctuation">(</span>CFLAGS<span class="token punctuation">)</span> <span class="token variable">$@.c</span> -o <span class="token variable">$@</span> <span class="token variable">$</span><span class="token punctuation">(</span>LDFLAGS<span class="token punctuation">)</span>

<span class="token target symbol">afl-tmin</span><span class="token punctuation">:</span> afl-tmin.c <span class="token variable">$</span><span class="token punctuation">(</span>COMM_HDR<span class="token punctuation">)</span> <span class="token operator">|</span> test_x86
	<span class="token variable">$</span><span class="token punctuation">(</span>CC<span class="token punctuation">)</span> <span class="token variable">$</span><span class="token punctuation">(</span>CFLAGS<span class="token punctuation">)</span> <span class="token variable">$@.c</span> -o <span class="token variable">$@</span> <span class="token variable">$</span><span class="token punctuation">(</span>LDFLAGS<span class="token punctuation">)</span>

<span class="token target symbol">afl-analyze</span><span class="token punctuation">:</span> afl-analyze.c <span class="token variable">$</span><span class="token punctuation">(</span>COMM_HDR<span class="token punctuation">)</span> <span class="token operator">|</span> test_x86
	<span class="token variable">$</span><span class="token punctuation">(</span>CC<span class="token punctuation">)</span> <span class="token variable">$</span><span class="token punctuation">(</span>CFLAGS<span class="token punctuation">)</span> <span class="token variable">$@.c</span> -o <span class="token variable">$@</span> <span class="token variable">$</span><span class="token punctuation">(</span>LDFLAGS<span class="token punctuation">)</span>

<span class="token target symbol">afl-gotcpu</span><span class="token punctuation">:</span> afl-gotcpu.c <span class="token variable">$</span><span class="token punctuation">(</span>COMM_HDR<span class="token punctuation">)</span> <span class="token operator">|</span> test_x86
	<span class="token variable">$</span><span class="token punctuation">(</span>CC<span class="token punctuation">)</span> <span class="token variable">$</span><span class="token punctuation">(</span>CFLAGS<span class="token punctuation">)</span> <span class="token variable">$@.c</span> -o <span class="token variable">$@</span> <span class="token variable">$</span><span class="token punctuation">(</span>LDFLAGS<span class="token punctuation">)</span>

<span class="token keyword">ifndef</span> AFL_NO_X86

<span class="token target symbol">test_build</span><span class="token punctuation">:</span> afl-gcc afl-as afl-showmap
	<span class="token operator">@</span>echo <span class="token string">"[*] Testing the CC wrapper and instrumentation output..."</span>
	unset AFL_USE_ASAN AFL_USE_MSAN<span class="token punctuation">;</span> AFL_QUIET<span class="token operator">=</span>1 AFL_INST_RATIO<span class="token operator">=</span>100 AFL_PATH<span class="token operator">=</span>. ./<span class="token variable">$</span><span class="token punctuation">(</span>TEST_CC<span class="token punctuation">)</span> <span class="token variable">$</span><span class="token punctuation">(</span>CFLAGS<span class="token punctuation">)</span> test-instr.c -o test-instr <span class="token variable">$</span><span class="token punctuation">(</span>LDFLAGS<span class="token punctuation">)</span>
	./afl-showmap -m none -q -o .test-instr0 ./test-instr &lt; /dev/null
	echo 1 <span class="token operator">|</span> ./afl-showmap -m none -q -o .test-instr1 ./test-instr
	<span class="token operator">@</span>rm -f test-instr
	<span class="token operator">@</span>cmp -s .test-instr0 .test-instr1<span class="token punctuation">;</span> DR<span class="token operator">=</span><span class="token string">"$$?"</span><span class="token punctuation">;</span> rm -f .test-instr0 .test-instr1<span class="token punctuation">;</span> if [ <span class="token string">"$$DR"</span> <span class="token operator">=</span> <span class="token string">"0"</span> ]<span class="token punctuation">;</span> then echo<span class="token punctuation">;</span> echo <span class="token string">"Oops, the instrumentation does not seem to be behaving correctly!"</span><span class="token punctuation">;</span> echo<span class="token punctuation">;</span> echo <span class="token string">"Please ping &lt;lcamtuf@google.com> to troubleshoot the issue."</span><span class="token punctuation">;</span> echo<span class="token punctuation">;</span> exit 1<span class="token punctuation">;</span> fi
	<span class="token operator">@</span>echo <span class="token string">"[+] All right, the instrumentation seems to be working!"</span>

<span class="token keyword">else</span>

<span class="token target symbol">test_build</span><span class="token punctuation">:</span> afl-gcc afl-as afl-showmap
	<span class="token operator">@</span>echo <span class="token string">"[!] Note: skipping build tests (you may need to use LLVM or QEMU mode)."</span>

<span class="token keyword">endif</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<ul>
<li>创建符号链接，使得 afl-g++, afl-clang, 和 afl-clang++ 都指向 afl-gcc</li>
<li>创建符号链接，使得 as 指向 afl-as</li>
</ul>
<h1 id="可能遇到的问题"><a href="#可能遇到的问题" class="headerlink" title="可能遇到的问题"></a>可能遇到的问题</h1><h2 id="clangd-插件找不到常量"><a href="#clangd-插件找不到常量" class="headerlink" title="clangd 插件找不到常量"></a>clangd 插件找不到常量</h2><p>解决办法：<br>clangd 可以从 compile_commands.json 中获取编译 flag，使用下面的命令就能生成：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">sudo apt install bear
bear -- make<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>
<h2 id="vscode-快捷键"><a href="#vscode-快捷键" class="headerlink" title="vscode 快捷键"></a>vscode 快捷键</h2><ul>
<li><code>f12</code>: 锁定变量\函数，跳转到定义 </li>
<li><code>ctrl+click</code>: 跳转到定义</li>
</ul>
<h1 id="afl-gcc"><a href="#afl-gcc" class="headerlink" title="afl-gcc"></a>afl-gcc</h1><p>afl-gcc 是对  GCC\CLANG 的一个wrapper ,通过 <code>Makefile</code> 文件可以看到是各种命名编译器的实际指向, 内部逻辑是首先找到afl-as（预处理汇编器），接着根据系统环境变量和提供的编译参数来去设置<strong>定制化编译参数</strong>，最后去调用下游汇编器 GCC\CLANG</p>
<p>main 函数核心代码如下：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-C" data-language="C"><code class="language-C">find_as(argv[0]);
edit_params(argc, argv);
execvp(cc_params[0], (char**)cc_params);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure>
<p>其中主要有如下三个函数的调用：</p>
<ul>
<li><code>find_as(argv[0])</code> ：查找汇编器路径，会从环境变量<code>$AFL_PATH</code>、<code>argv[0]</code> 所在的目录下、配置变量 <code>AFL_PATH</code> 依次寻找，缺省下为<code>本地项目路径/afl-as</code> </li>
<li><code>edit_params(argc, argv)</code>：处理传入的编译参数，将处理好的参数放入 <code>cc_params[]</code> 数组，并根据<code>argv[0]</code>确定使用哪一个编译器</li>
<li><code>execvp(cc_params[0], (cahr**)cc_params)</code> : 执行真正的编译器： GCC\CLANG</li>
</ul>
<h2 id="edit-params"><a href="#edit-params" class="headerlink" title="edit_params"></a>edit_params</h2><h3 id="逻辑如下："><a href="#逻辑如下：" class="headerlink" title="逻辑如下："></a>逻辑如下：</h3><ol>
<li><p>首先处理编译器的选择问题：</p>
<ul>
<li>分析  <code>argv[0]</code> ，提取到变量 <code>name</code> ( 其值为最后一个<code>/</code>后的字符串 ), 接着开始与固定字符串<code>afl-clang</code>进行对比，来确定自己需要调用哪个下游编译器。</li>
<li>例如，如果 <code>argv[0]</code> 是 <code>/afl/afl-clang </code>, 走入对应判断分支后,先获取<code>环境变量AFL_CC</code>的值，如果存在就填入<code>cc_params[0]</code>；否则将afl-clang赋值给cc_params[0]。这里可以看到 AFL 允许用户自己指定下游编译器，如果 AFL_CC 和 AFL_CXX 等变量都存在，则会覆盖掉默认编译器。</li>
</ul>
</li>
<li><p>接下来，进入 while 循环,  遍历从argv[1]开始的argv参数：</p>
<ul>
<li>如果扫描到 -B ，-B选项用于设置编译器的搜索路径，直接跳过。（find_as已处理as_path）</li>
<li>如果扫描到 -integrated-as，跳过</li>
<li>如果扫描到 -pipe，跳过</li>
<li>如果扫描到 <code>-fsanitize=address</code> 和 <code>-fsanitize=memory</code> 告诉 gcc 检查内存访问的错误，比如数组越界之类，设置 <code>asan_set = 1</code></li>
<li>如果扫描到 FORTIFY_SOURCE ，设置 <code>fortify_set = 1</code> 。FORTIFY_SOURCE 主要进行缓冲区溢出问题的检查，检查的常见函数有 <code>memcpy</code>, <code>mempcpy</code>, <code>memmove</code>, <code>memset</code>, <code>strcpy</code>, <code>stpcpy</code>, <code>strncpy</code>, <code>strcat</code>, <code>strncat</code>, <code>sprintf</code>, <code>vsprintf</code>, <code>snprintf</code>, <code>gets</code> 等</li>
</ul>
</li>
<li><p>接下来，跳出 while 循环,设置其他参数：</p>
<ul>
<li>设置 <code>-B as_path</code></li>
<li>如果是 <code>clang_mode</code> ，则设置 <code>-no-integrated-as</code></li>
<li>如果存在环境变量 AFL_HARDEN，则设置<code>-fstack-protector-all</code>。且如果没有设置 fortify_set ，追加 <code>-D_FORTIFY_SOURCE=2</code></li>
</ul>
</li>
<li><p>编译器优化相关参数，通过多个 if&#x2F;elif 进行判断:</p>
<ul>
<li>if + elif:<ul>
<li>如果 asan_set 在前面被设置为 1，即手动设置了<code>-fsanitize=memory</code>或者<code>-fsanitize=address</code>,则设置环境变量 <code>AFL_USE_ASAN=&quot;1&quot;</code></li>
<li>如果 asan_set 不为 1 且存在 AFL_USE_ASAN 环境变量，则<br>设置 <code>-U_FORTIFY_SOURCE -fsanitize=address</code></li>
<li>如果不存在 AFL_USE_ASAN 环境变量，但存在 AFL_USE_MSAN 环境变量，则<br>设置 <code>-U_FORTIFY_SOURCE -fsanitize=memory</code><br>不能同时指定AFL_USE_ASAN或者AFL_USE_MSAN，也不能同时指定 AFL_USE_MSAN 和 AFL_HARDEN，因为这样运行时速度过慢</li>
</ul>
</li>
<li>如果不存在 AFL_DONT_OPTIMIZE 环境变量，则<br>   设置<code>-g -O3 -funroll-loops -D__AFL_COMPILER=1 -DFUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION=1</code></li>
<li>如果存在 AFL_NO_BUILTIN 环境变量，则表示允许进行优化，<br>   设置  <figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">-fno-builtin-strcmp
-fno-builtin-strncmp
-fno-builtin-strcasecmp
-fno-builtin-strncasecmp
-fno-builtin-memcmp
-fno-builtin-strstr
-fno-builtin-strcasestr<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure></li>
</ul>
</li>
</ol>
<h1 id="afl-as"><a href="#afl-as" class="headerlink" title="afl-as"></a>afl-as</h1><p>在afl-gcc 的封装中，其中一个目的就是将原生 GNU as 替换为 afl-as。</p>
<p><code>afl-as</code> 也是一个原生 GNU as 的 wrapper。它的作用是预处理由 GCC&#x2F;clang 生成的汇编文件，并注入包含在 afl-as.h 中的插桩代码。 在上文 edit_params 函数中，已经通过<code>-B afl-as</code> 参数指定它参与到编译工具链中。</p>
<p>main 函数核心代码如下：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-C" data-language="C"><code class="language-C">u8* inst_ratio_str &#x3D; getenv(&quot;AFL_INST_RATIO&quot;);
struct timeval tv;
struct timezone tz;
gettimeofday(&amp;tv, &amp;tz);
rand_seed &#x3D; tv.tv_sec ^ tv.tv_usec ^ getpid();
&#x2F;&#x2F; 初始化随机数种子
srandom(rand_seed);
edit_params(argc, argv);
&#x2F;&#x2F; 在汇编指令序列上插桩  
if (!just_version) add_instrumentation();
&#x2F;&#x2F; few 
&#x2F;&#x2F; 子进程
if (!(pid &#x3D; fork())) &#123;
  execvp(as_params[0], (char**)as_params);
  FATAL(&quot;Oops, failed to execute &#39;%s&#39; - check your PATH&quot;, as_params[0]);

&#125;
if (pid &lt; 0) PFATAL(&quot;fork() failed&quot;);
if (waitpid(pid, &amp;status, 0) &lt;&#x3D; 0) PFATAL(&quot;waitpid() failed&quot;);
if (!getenv(&quot;AFL_KEEP_ASSEMBLY&quot;)) unlink(modified_file);
exit(WEXITSTATUS(status));<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>
<h2 id="main函数逻辑"><a href="#main函数逻辑" class="headerlink" title="main函数逻辑"></a>main函数逻辑</h2><ol>
<li><p>通过 <code>gettimeofday(&amp;tv,&amp;tz)</code>;获取时区和时间，然后设置 <code>srandom()</code> 的随机种子</p>
</li>
<li><p>调用 <code>edit_params</code> 函数，进行参数处理,确定 as 程序的名字，默认就是 GNU as，但用户也可以提供 AFL_AS 来覆盖,设置临时文件 <code>modified_file</code> 路径为 <code>/tmp/.afl-pid-timestamp.s</code></p>
</li>
<li><p>调用 <code>add_instrumentation()</code> 函数，这是实际的插桩函数</p>
</li>
<li><p>fork 一个子进程来执行 <code>execvp(as_params[0], (char**)as_params)</code>;。这里采用的是 fork 一个子进程的方式来执行插桩。这其实是因为我们的 execvp 执行的时候，会用 as_params[0] 来完全替换掉当前进程空间中的程序，如果不通过子进程来执行实际的 as，那么后续就无法在执行完实际的 as 之后，还能 <code>unlink</code> 掉 <code>modified_file</code></p>
</li>
<li><p>调用 <code>waitpid(pid, &amp;status, 0)</code> 等待子进程执行结束</p>
</li>
<li><p>判断是否设置 <code>AFL_KEEP_ASSEMBLY</code> ，如果没有设置这个环境变量，就 unlink 掉 <code>modified_file</code>(已插完桩的文件)。设置该环境变量主要是为了防止 afl-as 删掉插桩后的汇编文件，设置为 1 则会保留插桩后的汇编文件</p>
</li>
</ol>
<h2 id="add-instrumentation-插桩逻辑"><a href="#add-instrumentation-插桩逻辑" class="headerlink" title="add_instrumentation 插桩逻辑"></a>add_instrumentation 插桩逻辑</h2><ol>
<li><p>判断 <code>input_file</code> 是否为空，如果不为空则尝试打开文件获取 fd 赋值给 <code>inf</code>，失败则抛出异常；<code>input_file</code> 为空则 <code>inf</code> 设置为标准输入；</p>
</li>
<li><p>打开 <code>modified_file</code> ，获取 fd 赋值给 <code>outfd</code>，失败返回异常；进一步验证该文件是否可写，不可写返回异常；</p>
</li>
<li><p><code>while</code> 循环读取 <code>inf</code> 指向文件的每一行到 <code>line</code> 数组，每行最多 <code>MAX_LINE = 8192</code>个字节（含末尾的‘\0’），从<code>line</code>数组里将读取到的内容写入到 <code>outf</code> 指向的文件，然后进入到真正的插桩逻辑。这里需要注意的是，插桩只向 <code>.text</code> 段插入，：</p>
<ol>
<li><p>首先跳过标签、宏、注释；</p>
</li>
<li><p>这里结合部分关键代码进行解释。需要注意的是，变量 <code>instr_ok</code> 本质上是一个 flag，用于表示是否位于<code>.text</code>段。变量设置为 1，表示位于 <code>.text</code> 中，如果不为 1，则表示不再。于是，如果<code>instr_ok</code> 为 1，就会在分支处执行插桩逻辑，否则就不插桩。</p>
<ol>
<li><p>首先判断读入的行是否以‘\t’ 开头，本质上是在匹配<code>.s</code>文件中声明的段，然后判断<code>line[1]</code>是否为<code>.</code>：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">if (line[0] &#x3D;&#x3D; &#39;\t&#39; &amp;&amp; line[1] &#x3D;&#x3D; &#39;.&#39;) &#123;
 
      &#x2F;* OpenBSD puts jump tables directly inline with the code, which is
         a bit annoying. They use a specific format of p2align directives
         around them, so we use that as a signal. *&#x2F;
 
      if (!clang_mode &amp;&amp; instr_ok &amp;&amp; !strncmp(line + 2, &quot;p2align &quot;, 8) &amp;&amp;
          isdigit(line[10]) &amp;&amp; line[11] &#x3D;&#x3D; &#39;\n&#39;) skip_next_label &#x3D; 1;
 
      if (!strncmp(line + 2, &quot;text\n&quot;, 5) ||
          !strncmp(line + 2, &quot;section\t.text&quot;, 13) ||
          !strncmp(line + 2, &quot;section\t__TEXT,__text&quot;, 21) ||
          !strncmp(line + 2, &quot;section __TEXT,__text&quot;, 21)) &#123;
        instr_ok &#x3D; 1;
        continue;
      &#125;
 
      if (!strncmp(line + 2, &quot;section\t&quot;, 8) ||
          !strncmp(line + 2, &quot;section &quot;, 8) ||
          !strncmp(line + 2, &quot;bss\n&quot;, 4) ||
          !strncmp(line + 2, &quot;data\n&quot;, 5)) &#123;
        instr_ok &#x3D; 0;
        continue;
      &#125;
 
    &#125;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<ol>
<li>‘\t’开头，且<code>line[1]==&#39;.&#39;</code>，检查是否为 <code>p2align</code> 指令，如果是，则设置 <code>skip_next_label = 1</code>；</li>
<li>尝试匹配 <code>&quot;text\n&quot;</code> <code>&quot;section\t.text&quot;</code> <code>&quot;section\t__TEXT,__text&quot;</code> <code>&quot;section __TEXT,__text&quot;</code> 其中任意一个，匹配成功， 设置 <code>instr_ok = 1</code>， 表示位于 <code>.text</code> 段中，<code>continue</code> 跳出，进行下一次遍历；</li>
<li>尝试匹配<code>&quot;section\t&quot;</code> <code>&quot;section &quot;</code> <code>&quot;bss\n&quot;</code> <code>&quot;data\n&quot;</code> 其中任意一个，匹配成功，设置 <code>instr_ok = 0</code>，表位于其他段中，<code>continue</code> 跳出，进行下一次遍历；</li>
</ol>
</li>
<li><p>接下来通过几个 <code>if</code> 判断，来设置一些标志信息，包括 <code>off-flavor assembly</code>，<code>Intel/AT&amp;T</code>的块处理方式、<code>ad-hoc __asm__</code>块的处理方式等；</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">&#x2F;* Detect off-flavor assembly (rare, happens in gdb). When this is
   encountered, we set skip_csect until the opposite directive is
   seen, and we do not instrument. *&#x2F;
 
if (strstr(line, &quot;.code&quot;)) &#123;
 
  if (strstr(line, &quot;.code32&quot;)) skip_csect &#x3D; use_64bit;
  if (strstr(line, &quot;.code64&quot;)) skip_csect &#x3D; !use_64bit;
 
&#125;
 
&#x2F;* Detect syntax changes, as could happen with hand-written assembly.
   Skip Intel blocks, resume instrumentation when back to AT&amp;T. *&#x2F;
 
if (strstr(line, &quot;.intel_syntax&quot;)) skip_intel &#x3D; 1;
if (strstr(line, &quot;.att_syntax&quot;)) skip_intel &#x3D; 0;
 
&#x2F;* Detect and skip ad-hoc __asm__ blocks, likewise skipping them. *&#x2F;
 
if (line[0] &#x3D;&#x3D; &#39;#&#39; || line[1] &#x3D;&#x3D; &#39;#&#39;) &#123;
 
  if (strstr(line, &quot;#APP&quot;)) skip_app &#x3D; 1;
  if (strstr(line, &quot;#NO_APP&quot;)) skip_app &#x3D; 0;
 
&#125;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>
</li>
<li><p>AFL 在插桩时重点关注的内容包括：<code>^main, ^.L0, ^.LBB0_0, ^\tjnz foo</code> （_main 函数， gcc 和 clang 下的分支标记，条件跳转分支标记），这些内容通常标志了程序的流程变化，因此 AFL 会重点在这些位置进行插桩：</p>
<p>对于形如<code>\tj[^m].</code>格式的指令，即条件跳转指令，且<code>R(100)</code>产生的随机数小于插桩密度<code>inst_ratio</code>，直接使用<code>fprintf</code>将<code>trampoline_fmt_64</code>(插桩部分的指令) 写入 <code>outf</code> 指向的文件，写入大小为小于 <code>MAP_SIZE</code>的随机数——<code>R(MAP_SIZE)</code></p>
<p>，然后插桩计数<code>ins_lines</code>加一，<code>continue</code> 跳出，进行下一次遍历；</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">&#x2F;* If we&#39;re in the right mood for instrumenting, check for function
   names or conditional labels. This is a bit messy, but in essence,
   we want to catch:
 
     ^main:      - function entry point (always instrumented)
     ^.L0:       - GCC branch label
     ^.LBB0_0:   - clang branch label (but only in clang mode)
     ^\tjnz foo  - conditional branches
 
   ...but not:
 
     ^# BB#0:    - clang comments
     ^ # BB#0:   - ditto
     ^.Ltmp0:    - clang non-branch labels
     ^.LC0       - GCC non-branch labels
     ^.LBB0_0:   - ditto (when in GCC mode)
     ^\tjmp foo  - non-conditional jumps
 
   Additionally, clang and GCC on MacOS X follow a different convention
   with no leading dots on labels, hence the weird maze of #ifdefs
   later on.
 
 *&#x2F;
 
if (skip_intel || skip_app || skip_csect || !instr_ok ||
    line[0] &#x3D;&#x3D; &#39;#&#39; || line[0] &#x3D;&#x3D; &#39; &#39;) continue;
 
&#x2F;* Conditional branch instruction (jnz, etc). We append the instrumentation
   right after the branch (to instrument the not-taken path) and at the
   branch destination label (handled later on). *&#x2F;
 
if (line[0] &#x3D;&#x3D; &#39;\t&#39;) &#123;
 
  if (line[1] &#x3D;&#x3D; &#39;j&#39; &amp;&amp; line[2] !&#x3D; &#39;m&#39; &amp;&amp; R(100) &lt; inst_ratio) &#123;
 
    fprintf(outf, use_64bit ? trampoline_fmt_64 : trampoline_fmt_32,
            R(MAP_SIZE));
 
    ins_lines++;
 
  &#125;
 
  continue;
 
&#125;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>
</li>
<li><p>对于 label 的相关评估，有一些 label 可能是一些分支的目的地，需要自己的评判</p>
<p>首先检查该行中是否存在<code>:</code>，然后检查是否以<code>.</code>开始</p>
<ol>
<li><p>如果以<code>.</code>开始，则代表想要插桩<code>^.L0:</code>或者 <code>^.LBB0_0:</code>这样的 branch label，即 style jump destination</p>
<ol>
<li>检查 <code>line[2]</code>是否为数字 或者 如果是在 clang_mode 下，比较从<code>line[1]</code>开始的三个字节是否为<code>LBB.</code>，前述所得结果和<code>R(100) &lt; inst_ratio)</code>相与。如果结果为真，则设置<code>instrument_next = 1</code>；</li>
</ol>
</li>
<li><p>否则代表这是一个 function，插桩<code>^func:</code>，function entry point，直接设置<code>instrument_next = 1</code>（defer mode）。</p>
</li>
</ol>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">    &#x2F;* Label of some sort. This may be a branch destination, but we need to
       tread carefully and account for several different formatting
       conventions. *&#x2F;
 
#ifdef __APPLE__
 
    &#x2F;* Apple: L: *&#x2F;
 
    if ((colon_pos &#x3D; strstr(line, &quot;:&quot;))) &#123;
 
      if (line[0] &#x3D;&#x3D; &#39;L&#39; &amp;&amp; isdigit(*(colon_pos - 1))) &#123;
 
#else
 
    &#x2F;* Everybody else: .L: *&#x2F;
 
    if (strstr(line, &quot;:&quot;)) &#123;
 
      if (line[0] &#x3D;&#x3D; &#39;.&#39;) &#123;
 
#endif &#x2F;* __APPLE__ *&#x2F;
 
        &#x2F;* .L0: or LBB0_0: style jump destination *&#x2F;
 
#ifdef __APPLE__
 
        &#x2F;* Apple: L &#x2F; LBB *&#x2F;
 
        if ((isdigit(line[1]) || (clang_mode &amp;&amp; !strncmp(line, &quot;LBB&quot;, 3)))
            &amp;&amp; R(100) &lt; inst_ratio) &#123;
 
#else
 
        &#x2F;* Apple: .L &#x2F; .LBB *&#x2F;
 
        if ((isdigit(line[2]) || (clang_mode &amp;&amp; !strncmp(line + 1, &quot;LBB&quot;, 3)))
            &amp;&amp; R(100) &lt; inst_ratio) &#123;
 
#endif &#x2F;* __APPLE__ *&#x2F;
 
          &#x2F;* An optimization is possible here by adding the code only if the
             label is mentioned in the code in contexts other than call &#x2F; jmp.
             That said, this complicates the code by requiring two-pass
             processing (messy with stdin), and results in a speed gain
             typically under 10%, because compilers are generally pretty good
             about not generating spurious intra-function jumps.
 
             We use deferred output chiefly to avoid disrupting
             .Lfunc_begin0-style exception handling calculations (a problem on
             MacOS X). *&#x2F;
 
          if (!skip_next_label) instrument_next &#x3D; 1; else skip_next_label &#x3D; 0;
 
        &#125;
 
      &#125; else &#123;
 
        &#x2F;* Function label (always instrumented, deferred mode). *&#x2F;
 
        instrument_next &#x3D; 1;
 
      &#125;
    &#125;
  &#125; <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>
</li>
<li><p>上述过程完成后，来到 <code>while</code> 循环的下一个循环，在 <code>while</code> 的开头，可以看到对以 defered mode 进行插桩的位置进行了真正的插桩处理：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">if (!pass_thru &amp;&amp; !skip_intel &amp;&amp; !skip_app &amp;&amp; !skip_csect &amp;&amp; instr_ok &amp;&amp;
    instrument_next &amp;&amp; line[0] &#x3D;&#x3D; &#39;\t&#39; &amp;&amp; isalpha(line[1])) &#123;
 
  fprintf(outf, use_64bit ? trampoline_fmt_64 : trampoline_fmt_32,
          R(MAP_SIZE));
 
  instrument_next &#x3D; 0;
  ins_lines++;
 
&#125;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>这里对 <code>instr_ok, instrument_next</code> 变量进行了检验是否为 1，而且进一步校验是否位于 <code>.text</code> 段中，且设置了 defered mode 进行插桩，则就进行插桩操作，写入 <code>trampoline_fmt_64/32</code> 。</p>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<p>至此，插桩函数 <code>add_instrumentation</code> 的主要逻辑已梳理完成。</p>
<h2 id="afl-as-h-桩代码逻辑"><a href="#afl-as-h-桩代码逻辑" class="headerlink" title="afl-as.h 桩代码逻辑"></a>afl-as.h 桩代码逻辑</h2><p>关于这部分的分析，最好的学习办法是设置 <code>AFL_KEEP_ASSEMBLY=1 </code>去编译 ,对比插桩前后汇编代码差异</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># afl-gcc</span>
<span class="token assign-left variable">AFL_KEEP_ASSEMBLY</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">AFL_DONT_OPTIMIZE</span><span class="token operator">=</span><span class="token number">1</span> <span class="token punctuation">..</span>/afl-gcc test_as.c <span class="token parameter variable">-o</span> test_as <span class="token parameter variable">-O0</span> -fno-asynchronous-unwind-tables
<span class="token function">ls</span> <span class="token parameter variable">-al</span> /tmp/.afl-16830-1734879283.s
<span class="token function">cp</span> /tmp/.afl-16830-1734879283.s ./
<span class="token comment"># 原生gcc</span>
gcc <span class="token parameter variable">-S</span> test_as.c <span class="token parameter variable">-O0</span> -fno-asynchronous-unwind-tables  <span class="token parameter variable">-o</span> test_as1.o<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>插桩后的汇编代码会在每一个基本块入口处插入了一段代码，且在程序末尾，写有 AFL 桩代码变量定义和桩代码函数实现</p>
<p>关于instrumentation trampoline 代码带注释分析</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* --- AFL TRAMPOLINE (64-BIT) --- */</span>

<span class="token punctuation">.</span>align <span class="token number">4</span>

leaq <span class="token operator">-</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token operator">+</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>rsp
movq <span class="token operator">%</span>rdx<span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span>
movq <span class="token operator">%</span>rcx<span class="token punctuation">,</span>  <span class="token number">8</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span>
movq <span class="token operator">%</span>rax<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span>
movq $<span class="token number">0x0000eb91</span><span class="token punctuation">,</span> <span class="token operator">%</span>rcx <span class="token comment">// 向ecx中存入识别代码块的随机桩代码id</span>
call __afl_maybe_log
movq <span class="token number">16</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>rax
movq  <span class="token number">8</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>rcx
movq  <span class="token number">0</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>rdx
<span class="token function">leaq</span> <span class="token punctuation">(</span><span class="token number">128</span><span class="token operator">+</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>rsp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// RCX: 识别代码块的随机桩代码id</span>
__afl_maybe_log<span class="token operator">:</span>
<span class="token comment">// 将标志位加载到 AH</span>
<span class="token comment">// 将 OF 位保存在 al</span>
  lahf
  seto  <span class="token operator">%</span>al

  <span class="token comment">/* Check if SHM region is already mapped. */</span>

  movq  <span class="token function">__afl_area_ptr</span><span class="token punctuation">(</span><span class="token operator">%</span>rip<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>rdx
  <span class="token comment">//按位与=> 检查rdx是否为0  如果结果为0 ZF is 1</span>
  testq <span class="token operator">%</span>rdx<span class="token punctuation">,</span> <span class="token operator">%</span>rdx
  je    __afl_setup

__afl_store<span class="token operator">:</span>

  <span class="token comment">/* Calculate and store hit for the code location specified in rcx. */</span>
  <span class="token comment">// 更新rcx的值为__afl_prev_loc(%rip) ^ rcx</span>
  <span class="token comment">// 更新__afl_prev_loc(%rip)的值为 原rcx</span>
  xorq <span class="token function">__afl_prev_loc</span><span class="token punctuation">(</span><span class="token operator">%</span>rip<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>rcx
  xorq <span class="token operator">%</span>rcx<span class="token punctuation">,</span> <span class="token function">__afl_prev_loc</span><span class="token punctuation">(</span><span class="token operator">%</span>rip<span class="token punctuation">)</span>
  shrq $<span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">__afl_prev_loc</span><span class="token punctuation">(</span><span class="token operator">%</span>rip<span class="token punctuation">)</span>

  <span class="token comment">// [rdx +rcx*1] += 1  增加 hit count</span>
  <span class="token function">incb</span> <span class="token punctuation">(</span><span class="token operator">%</span>rdx<span class="token punctuation">,</span> <span class="token operator">%</span>rcx<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

__afl_return<span class="token operator">:</span>

  addb $<span class="token number">127</span><span class="token punctuation">,</span> <span class="token operator">%</span>al
  sahf
  ret

<span class="token punctuation">.</span>align <span class="token number">8</span>

__afl_setup<span class="token operator">:</span>

  <span class="token comment">/* Do not retry setup if we had previous failures. */</span>

  cmpb $<span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">__afl_setup_failure</span><span class="token punctuation">(</span><span class="token operator">%</span>rip<span class="token punctuation">)</span>
  jne __afl_return

  <span class="token comment">/* Check out if we have a global pointer on file. */</span>

  movq  __afl_global_area_ptr@<span class="token function">GOTPCREL</span><span class="token punctuation">(</span><span class="token operator">%</span>rip<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>rdx
  <span class="token function">movq</span>  <span class="token punctuation">(</span><span class="token operator">%</span>rdx<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>rdx
  <span class="token comment">// 判断rdx 是否为0</span>
  testq <span class="token operator">%</span>rdx<span class="token punctuation">,</span> <span class="token operator">%</span>rdx
  <span class="token comment">// 为0 跳到__afl_setup_first</span>
  je    __afl_setup_first

  movq <span class="token operator">%</span>rdx<span class="token punctuation">,</span> <span class="token function">__afl_area_ptr</span><span class="token punctuation">(</span><span class="token operator">%</span>rip<span class="token punctuation">)</span>
  jmp  __afl_store

__afl_setup_first<span class="token operator">:</span>

  <span class="token comment">/* Save everything that is not yet saved and that may be touched by
     getenv() and several other libcalls we'll be relying on. */</span>
  <span class="token comment">// </span>
  leaq <span class="token operator">-</span><span class="token number">352</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>rsp

  movq <span class="token operator">%</span>rax<span class="token punctuation">,</span>   <span class="token number">0</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span>
  movq <span class="token operator">%</span>rcx<span class="token punctuation">,</span>   <span class="token number">8</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span>
  movq <span class="token operator">%</span>rdi<span class="token punctuation">,</span>  <span class="token number">16</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span>
  movq <span class="token operator">%</span>rsi<span class="token punctuation">,</span>  <span class="token number">32</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span>
  movq <span class="token operator">%</span>r8<span class="token punctuation">,</span>   <span class="token number">40</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span>
  movq <span class="token operator">%</span>r9<span class="token punctuation">,</span>   <span class="token number">48</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span>
  movq <span class="token operator">%</span>r10<span class="token punctuation">,</span>  <span class="token number">56</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span>
  movq <span class="token operator">%</span>r11<span class="token punctuation">,</span>  <span class="token number">64</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span>

  movq <span class="token operator">%</span>xmm0<span class="token punctuation">,</span>  <span class="token number">96</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span>
  movq <span class="token operator">%</span>xmm1<span class="token punctuation">,</span>  <span class="token number">112</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span>
  movq <span class="token operator">%</span>xmm2<span class="token punctuation">,</span>  <span class="token number">128</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span>
  movq <span class="token operator">%</span>xmm3<span class="token punctuation">,</span>  <span class="token number">144</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span>
  movq <span class="token operator">%</span>xmm4<span class="token punctuation">,</span>  <span class="token number">160</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span>
  movq <span class="token operator">%</span>xmm5<span class="token punctuation">,</span>  <span class="token number">176</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span>
  movq <span class="token operator">%</span>xmm6<span class="token punctuation">,</span>  <span class="token number">192</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span>
  movq <span class="token operator">%</span>xmm7<span class="token punctuation">,</span>  <span class="token number">208</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span>
  movq <span class="token operator">%</span>xmm8<span class="token punctuation">,</span>  <span class="token number">224</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span>
  movq <span class="token operator">%</span>xmm9<span class="token punctuation">,</span>  <span class="token number">240</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span>
  movq <span class="token operator">%</span>xmm10<span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span>
  movq <span class="token operator">%</span>xmm11<span class="token punctuation">,</span> <span class="token number">272</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span>
  movq <span class="token operator">%</span>xmm12<span class="token punctuation">,</span> <span class="token number">288</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span>
  movq <span class="token operator">%</span>xmm13<span class="token punctuation">,</span> <span class="token number">304</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span>
  movq <span class="token operator">%</span>xmm14<span class="token punctuation">,</span> <span class="token number">320</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span>
  movq <span class="token operator">%</span>xmm15<span class="token punctuation">,</span> <span class="token number">336</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span>

  <span class="token comment">/* Map SHM, jumping to __afl_setup_abort if something goes wrong. */</span>

  <span class="token comment">/* The 64-bit ABI requires 16-byte stack alignment. We'll keep the
     original stack ptr in the callee-saved r12. */</span>

  <span class="token comment">// 堆栈对齐</span>
  pushq <span class="token operator">%</span>r12
  movq  <span class="token operator">%</span>rsp<span class="token punctuation">,</span> <span class="token operator">%</span>r12
  subq  $<span class="token number">16</span><span class="token punctuation">,</span> <span class="token operator">%</span>rsp
  andq  $<span class="token number">0xfffffffffffffff0</span><span class="token punctuation">,</span> <span class="token operator">%</span>rsp
  <span class="token comment">//0x5555555557d7 (.AFL_VARS) => getenv("__AFL_SHM_ID") 如果不存在返回0</span>
  leaq <span class="token punctuation">.</span><span class="token function">AFL_SHM_ENV</span><span class="token punctuation">(</span><span class="token operator">%</span>rip<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>rdi
call getenv@PLT

  testq <span class="token operator">%</span>rax<span class="token punctuation">,</span> <span class="token operator">%</span>rax
  je    __afl_setup_abort

  <span class="token comment">// 把 __AFL_SHM_ID 从字符串转成整数</span>
  movq  <span class="token operator">%</span>rax<span class="token punctuation">,</span> <span class="token operator">%</span>rdi
call atoi@PLT

  xorq <span class="token operator">%</span>rdx<span class="token punctuation">,</span> <span class="token operator">%</span>rdx   <span class="token comment">/* shmat flags    */</span>
  xorq <span class="token operator">%</span>rsi<span class="token punctuation">,</span> <span class="token operator">%</span>rsi   <span class="token comment">/* requested addr */</span>
  <span class="token comment">// rax 返回值</span>
  movq <span class="token operator">%</span>rax<span class="token punctuation">,</span> <span class="token operator">%</span>rdi   <span class="token comment">/* SHM ID         */</span>
call shmat@PLT

  cmpq $<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">%</span>rax
  je   __afl_setup_abort
  <span class="token comment">/*
    　　上面的汇编代码中，如果发现 attach 失败，则进入 AFL 的错误处理流程。不过读到这里，我们有一个小疑问：一片共享内存，首先应当由 shmget() 创建，再由 shmat() 映射到当前程序的虚拟内存空间中。那么，这片虚拟内存是什么时候创建的？答案是 afl-fuzz 在 setup_shm() 流程中调用 shmget() 创建了虚拟内存，并将 shm id 写入 __AFL_SHM_ID 环境变量。如果我们并非通过 afl-fuzz 运行程序，自然这片虚拟内存不会被创建，也不会存在 __AFL_SHM_ID 环境变量了。
  */</span>

  <span class="token comment">/* Store the address of the SHM region. */</span>

  movq <span class="token operator">%</span>rax<span class="token punctuation">,</span> <span class="token operator">%</span>rdx
  movq <span class="token operator">%</span>rax<span class="token punctuation">,</span> <span class="token function">__afl_area_ptr</span><span class="token punctuation">(</span><span class="token operator">%</span>rip<span class="token punctuation">)</span>

  movq __afl_global_area_ptr@<span class="token function">GOTPCREL</span><span class="token punctuation">(</span><span class="token operator">%</span>rip<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>rdx
  movq <span class="token operator">%</span>rax<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">%</span>rdx<span class="token punctuation">)</span>
  movq <span class="token operator">%</span>rax<span class="token punctuation">,</span> <span class="token operator">%</span>rdx

__afl_forkserver<span class="token operator">:</span>

  <span class="token comment">/* Enter the fork server mode to avoid the overhead of execve() calls. We
     push rdx (area ptr) twice to keep stack alignment neat. */</span>

  pushq <span class="token operator">%</span>rdx
  pushq <span class="token operator">%</span>rdx

  <span class="token comment">/* Phone home and tell the parent that we're OK. (Note that signals with
     no SA_RESTART will mess it up). If this fails, assume that the fd is
     closed because we were execve()d from an instrumented binary, or because
     the parent doesn't want to use the fork server. */</span>
  <span class="token comment">// 等待 fuzzer 通过控制管道发送过来的命令，读入到 __afl_temp 中</span>
  movq $<span class="token number">4</span><span class="token punctuation">,</span> <span class="token operator">%</span>rdx               <span class="token comment">/* length    */</span>
  leaq <span class="token function">__afl_temp</span><span class="token punctuation">(</span><span class="token operator">%</span>rip<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>rsi <span class="token comment">/* data      */</span>
  movq $<span class="token punctuation">(</span><span class="token number">198</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>rdi       <span class="token comment">/* file desc */</span>
call write@PLT

  cmpq $<span class="token number">4</span><span class="token punctuation">,</span> <span class="token operator">%</span>rax
  jne  __afl_fork_resume

__afl_fork_wait_loop<span class="token operator">:</span>

  <span class="token comment">/* Wait for parent by reading from the pipe. Abort if read fails. */</span>

  movq $<span class="token number">4</span><span class="token punctuation">,</span> <span class="token operator">%</span>rdx               <span class="token comment">/* length    */</span>
  leaq <span class="token function">__afl_temp</span><span class="token punctuation">(</span><span class="token operator">%</span>rip<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>rsi <span class="token comment">/* data      */</span>
  movq $<span class="token number">198</span><span class="token punctuation">,</span> <span class="token operator">%</span>rdi             <span class="token comment">/* file desc */</span>
call read@PLT
  cmpq $<span class="token number">4</span><span class="token punctuation">,</span> <span class="token operator">%</span>rax
  jne  __afl_die

  <span class="token comment">/* Once woken up, create a clone of our process. This is an excellent use
     case for syscall(__NR_clone, 0, CLONE_PARENT), but glibc boneheadedly
     caches getpid() results and offers no way to update the value, breaking
     abort(), raise(), and a bunch of other things :-( */</span>

call fork@PLT
  cmpq $<span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">%</span>rax
  <span class="token comment">//jump if rax &lt; 0</span>
  jl   __afl_die
  <span class="token comment">// child</span>
  je   __afl_fork_resume

  <span class="token comment">/* In parent process: write PID to pipe, then wait for child. */</span>
  <span class="token comment">//将子进程的 pid 保存到 __afl_fork_pid 变量</span>
  movl <span class="token operator">%</span>eax<span class="token punctuation">,</span> <span class="token function">__afl_fork_pid</span><span class="token punctuation">(</span><span class="token operator">%</span>rip<span class="token punctuation">)</span>

  <span class="token comment">//向 fd 199 写入子进程的 pid</span>
  movq $<span class="token number">4</span><span class="token punctuation">,</span> <span class="token operator">%</span>rdx                   <span class="token comment">/* length    */</span>
  leaq <span class="token function">__afl_fork_pid</span><span class="token punctuation">(</span><span class="token operator">%</span>rip<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>rsi <span class="token comment">/* data      */</span>
  movq $<span class="token punctuation">(</span><span class="token number">198</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>rdi             <span class="token comment">/* file desc */</span>
call write@PLT

  movq $<span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">%</span>rdx                   <span class="token comment">/* no flags  */</span>
  leaq <span class="token function">__afl_temp</span><span class="token punctuation">(</span><span class="token operator">%</span>rip<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>rsi     <span class="token comment">/* status    */</span>
  movq <span class="token function">__afl_fork_pid</span><span class="token punctuation">(</span><span class="token operator">%</span>rip<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>rdi <span class="token comment">/* PID       */</span>
call waitpid@PLT
  cmpq $<span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">%</span>rax
  jle  __afl_die

  <span class="token comment">/* Relay wait status to pipe, then loop back. */</span>
  <span class="token comment">// 写入状态管道告知 fuzzer</span>
  movq $<span class="token number">4</span><span class="token punctuation">,</span> <span class="token operator">%</span>rdx               <span class="token comment">/* length    */</span>
  leaq <span class="token function">__afl_temp</span><span class="token punctuation">(</span><span class="token operator">%</span>rip<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>rsi <span class="token comment">/* data      */</span>
  movq $<span class="token punctuation">(</span><span class="token number">198</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>rdi         <span class="token comment">/* file desc */</span>
call write@PLT

  jmp  __afl_fork_wait_loop

__afl_fork_resume<span class="token operator">:</span>

  <span class="token comment">/* In child process: close fds, resume execution. */</span>

  movq $<span class="token number">198</span><span class="token punctuation">,</span> <span class="token operator">%</span>rdi
call close@PLT

  movq $<span class="token punctuation">(</span><span class="token number">198</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>rdi
call close@PLT

  popq <span class="token operator">%</span>rdx
  popq <span class="token operator">%</span>rdx

  movq <span class="token operator">%</span>r12<span class="token punctuation">,</span> <span class="token operator">%</span>rsp
  popq <span class="token operator">%</span>r12

  movq  <span class="token number">0</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>rax
  movq  <span class="token number">8</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>rcx
  movq <span class="token number">16</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>rdi
  movq <span class="token number">32</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>rsi
  movq <span class="token number">40</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>r8
  movq <span class="token number">48</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>r9
  movq <span class="token number">56</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>r10
  movq <span class="token number">64</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>r11

  movq  <span class="token number">96</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>xmm0
  movq <span class="token number">112</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>xmm1
  movq <span class="token number">128</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>xmm2
  movq <span class="token number">144</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>xmm3
  movq <span class="token number">160</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>xmm4
  movq <span class="token number">176</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>xmm5
  movq <span class="token number">192</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>xmm6
  movq <span class="token number">208</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>xmm7
  movq <span class="token number">224</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>xmm8
  movq <span class="token number">240</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>xmm9
  movq <span class="token number">256</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>xmm10
  movq <span class="token number">272</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>xmm11
  movq <span class="token number">288</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>xmm12
  movq <span class="token number">304</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>xmm13
  movq <span class="token number">320</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>xmm14
  movq <span class="token number">336</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>xmm15

  leaq <span class="token number">352</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>rsp

  jmp  __afl_store

__afl_die<span class="token operator">:</span>

  xorq <span class="token operator">%</span>rax<span class="token punctuation">,</span> <span class="token operator">%</span>rax
call _exit@PLT

__afl_setup_abort<span class="token operator">:</span>

  <span class="token comment">/* Record setup failure so that we don't keep calling
     shmget() / shmat() over and over again. */</span>

  incb <span class="token function">__afl_setup_failure</span><span class="token punctuation">(</span><span class="token operator">%</span>rip<span class="token punctuation">)</span>

  movq <span class="token operator">%</span>r12<span class="token punctuation">,</span> <span class="token operator">%</span>rsp
  popq <span class="token operator">%</span>r12

  movq  <span class="token number">0</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>rax
  movq  <span class="token number">8</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>rcx
  movq <span class="token number">16</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>rdi
  movq <span class="token number">32</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>rsi
  movq <span class="token number">40</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>r8
  movq <span class="token number">48</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>r9
  movq <span class="token number">56</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>r10
  movq <span class="token number">64</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>r11

  movq  <span class="token number">96</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>xmm0
  movq <span class="token number">112</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>xmm1
  movq <span class="token number">128</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>xmm2
  movq <span class="token number">144</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>xmm3
  movq <span class="token number">160</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>xmm4
  movq <span class="token number">176</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>xmm5
  movq <span class="token number">192</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>xmm6
  movq <span class="token number">208</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>xmm7
  movq <span class="token number">224</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>xmm8
  movq <span class="token number">240</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>xmm9
  movq <span class="token number">256</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>xmm10
  movq <span class="token number">272</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>xmm11
  movq <span class="token number">288</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>xmm12
  movq <span class="token number">304</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>xmm13
  movq <span class="token number">320</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>xmm14
  movq <span class="token number">336</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>xmm15

  leaq <span class="token number">352</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>rsp

  jmp __afl_return

<span class="token punctuation">.</span>AFL_VARS<span class="token operator">:</span>

  <span class="token punctuation">.</span>lcomm   __afl_area_ptr<span class="token punctuation">,</span> <span class="token number">8</span>
  <span class="token punctuation">.</span>lcomm   __afl_prev_loc<span class="token punctuation">,</span> <span class="token number">8</span>
  <span class="token punctuation">.</span>lcomm   __afl_fork_pid<span class="token punctuation">,</span> <span class="token number">4</span>
  <span class="token punctuation">.</span>lcomm   __afl_temp<span class="token punctuation">,</span> <span class="token number">4</span>
  <span class="token punctuation">.</span>lcomm   __afl_setup_failure<span class="token punctuation">,</span> <span class="token number">1</span>
  <span class="token punctuation">.</span>comm    __afl_global_area_ptr<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">8</span>

<span class="token punctuation">.</span>AFL_SHM_ENV<span class="token operator">:</span>
  <span class="token punctuation">.</span>asciz <span class="token string">"__AFL_SHM_ID"</span>

<span class="token comment">/* --- END --- */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>


<h1 id="afl-tmin"><a href="#afl-tmin" class="headerlink" title="afl-tmin"></a>afl-tmin</h1><p>afl-tmin是一个简单的测试用例最小化器，它接受一个输入文件，并试图删除尽可能多的数据，同时保持二进制文件处于崩溃状态或产生一致的仪器输出（模式是根据最初观察到的行为自动选择的）</p>
<p>afl-tmin 用于将测试用例最小化，同时保持触发相同的代码路径或行为的能力</p>
<p>main 函数核心代码如下：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-C" data-language="C"><code class="language-C">setup_shm();
setup_signal_handlers();
set_up_environment();

find_binary(argv[optind]);
detect_file_args(argv + optind);
read_initial_file();
run_target(use_argv, in_data, in_len, 1);
minimize(use_argv);
unlink(prog_in);
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h2 id="main-函数逻辑"><a href="#main-函数逻辑" class="headerlink" title="main 函数逻辑"></a>main 函数逻辑</h2><ol>
<li>初始化共享内存， 初始化共享内存（Shared Memory, shm）</li>
<li><code>setup_signal_handlers() </code> 设置信号处理程序是为了确保程序能够在接收到特定信号（如用户中断 Ctrl+C）时优雅地结束运行，而不是突然终止，这样可以避免数据丢失或文件损坏</li>
<li><code>set_up_environment()</code>  配置环境变量，比如设置临时文件的位置、启用地址&#x2F;内存 sanitizer (ASAN&#x2F;MSAN) 工具来检测潜在的安全问题，以及可能预加载某些库（通过 LD_PRELOAD 环境变量）</li>
<li><code>find_binary(argv[optind]) </code> 查找并确认将要模糊测试的目标程序（二进制文件）。<code>argv[optind]</code> 是命令行参数数组的一部分，包含了目标程序的路径</li>
<li><code>detect_file_args(argv + optind);</code>  分析命令行参数，识别出哪些参数代表文件路径，并特别处理占位符 <code>@@</code>，将其替换为实际的输入文件位置</li>
<li><code>read_initial_file();</code> 读取提供的初始输入文件内容，这些内容将被用作模糊测试的基础或作为最小化过程的起点</li>
<li><code>run_target(use_argv, in_data, in_len, 1);</code> 使用指定的参数和输入数据对目标程序进行一次无操作运行（dry run），目的是检查是否存在超时或崩溃的问题，以确保后续最小化过程的正确性</li>
<li><code>minimize(use_argv);</code> <strong>执行核心的最小化逻辑</strong>，尝试减少输入文件的大小而不改变其触发相同代码路径或行为的能力</li>
<li><code>unlink(prog_in);</code>  最后，删除创建的临时输入文件（prog_in）</li>
</ol>
<p>可以看出，重点函数是 <code>minimize</code> 最小化逻辑，其中 <code>run_target</code>函数逻辑里有一个<code>hit count</code>机制的实现，也比较关键，故我们重点分析这两个函数</p>
<h2 id="run-target"><a href="#run-target" class="headerlink" title="run_target"></a>run_target</h2><figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Execute target application. Returns 0 if the changes are a dud, or
   1 if they should be kept. */</span>

<span class="token keyword">static</span> u8 <span class="token function">run_target</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">,</span> u8<span class="token operator">*</span> mem<span class="token punctuation">,</span> u32 len<span class="token punctuation">,</span> u8 first_run<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  <span class="token comment">//  运行前的准备</span>
  <span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">itimerval</span> it<span class="token punctuation">;</span>
  <span class="token keyword">int</span> status <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  s32 prog_in_fd<span class="token punctuation">;</span>
  u32 cksum<span class="token punctuation">;</span>

  <span class="token function">memset</span><span class="token punctuation">(</span>trace_bits<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MAP_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">MEM_BARRIER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  prog_in_fd <span class="token operator">=</span> <span class="token function">write_to_file</span><span class="token punctuation">(</span>prog_in<span class="token punctuation">,</span> mem<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>

  child_pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>child_pid <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"fork() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>child_pid<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//  子进程代码</span>
      <span class="token keyword">struct</span> <span class="token class-name">rlimit</span> r<span class="token punctuation">;</span>
    <span class="token comment">// stdin 指向输入文件、stdout 和 stderr 指向 /dev/null</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dup2</span><span class="token punctuation">(</span>use_stdin <span class="token operator">?</span> prog_in_fd <span class="token operator">:</span> dev_null_fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span>
        <span class="token function">dup2</span><span class="token punctuation">(</span>dev_null_fd<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span>
        <span class="token function">dup2</span><span class="token punctuation">(</span>dev_null_fd<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

      <span class="token operator">*</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span>trace_bits <span class="token operator">=</span> EXEC_FAIL_SIG<span class="token punctuation">;</span>
      <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"dup2() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token function">close</span><span class="token punctuation">(</span>dev_null_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>prog_in_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">setsid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 设置内存限制</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mem_limit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

      r<span class="token punctuation">.</span>rlim_max <span class="token operator">=</span> r<span class="token punctuation">.</span>rlim_cur <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">rlim_t</span><span class="token punctuation">)</span>mem_limit<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">20</span><span class="token punctuation">;</span>

    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">RLIMIT_AS</span></span>
        <span class="token function">setrlimit</span><span class="token punctuation">(</span>RLIMIT_AS<span class="token punctuation">,</span> <span class="token operator">&amp;</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* Ignore errors */</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
        <span class="token function">setrlimit</span><span class="token punctuation">(</span>RLIMIT_DATA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* Ignore errors */</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^RLIMIT_AS */</span></span>

    <span class="token punctuation">&#125;</span>

    r<span class="token punctuation">.</span>rlim_max <span class="token operator">=</span> r<span class="token punctuation">.</span>rlim_cur <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">setrlimit</span><span class="token punctuation">(</span>RLIMIT_CORE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* Ignore errors */</span>

    <span class="token comment">// execv 目标程序</span>
    <span class="token function">execv</span><span class="token punctuation">(</span>target_path<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果程序运行到了这里，说明 execv 失败了，把 shm 前四个字节设为 0xfee1dead</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span>trace_bits <span class="token operator">=</span> EXEC_FAIL_SIG<span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>


  <span class="token function">close</span><span class="token punctuation">(</span>prog_in_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 设置 timeout</span>
  child_timed_out <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  it<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token punctuation">(</span>exec_tmout <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  it<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token punctuation">(</span>exec_tmout <span class="token operator">%</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
  <span class="token comment">// SIGALRM 的 handler 此前已被设为「kill 掉 child_pid」</span>
  <span class="token function">setitimer</span><span class="token punctuation">(</span>ITIMER_REAL<span class="token punctuation">,</span> <span class="token operator">&amp;</span>it<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">waitpid</span><span class="token punctuation">(</span>child_pid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>status<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"waitpid() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 取消定时器</span>
  child_pid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  it<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  it<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">setitimer</span><span class="token punctuation">(</span>ITIMER_REAL<span class="token punctuation">,</span> <span class="token operator">&amp;</span>it<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">MEM_BARRIER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 接下来分析 shm</span>

  <span class="token comment">// execv 是否成功</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span>trace_bits <span class="token operator">==</span> EXEC_FAIL_SIG<span class="token punctuation">)</span>
    <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to execute '%s'"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 对 hit count 分桶</span>
  <span class="token function">classify_counts</span><span class="token punctuation">(</span>trace_bits<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">apply_mask</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span>trace_bits<span class="token punctuation">,</span> <span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span>mask_bitmap<span class="token punctuation">)</span><span class="token punctuation">;</span>
  total_execs<span class="token operator">++</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>stop_soon<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">SAYF</span><span class="token punctuation">(</span>cRST cLRD <span class="token string">"\n+++ Minimization aborted by user +++\n"</span> cRST<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span><span class="token function">write_to_file</span><span class="token punctuation">(</span>out_file<span class="token punctuation">,</span> in_data<span class="token punctuation">,</span> in_len<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// 如果执行超时，则返回 0，表示这个 input 应该忽略</span>
  <span class="token comment">/* Always discard inputs that time out. */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>child_timed_out<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    missed_hangs<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>


  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WIFSIGNALED</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token operator">||</span>
      <span class="token punctuation">(</span><span class="token function">WIFEXITED</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">WEXITSTATUS</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token operator">==</span> MSAN_ERROR<span class="token punctuation">)</span> <span class="token operator">||</span>
      <span class="token punctuation">(</span><span class="token function">WIFEXITED</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">WEXITSTATUS</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> exit_crash<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 若发现目标程序 crash</span>
    
    <span class="token comment">// 如果是初次运行就 crash，说明该使用 crash mode</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>first_run<span class="token punctuation">)</span> crash_mode <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>crash_mode<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 如果是 crash mode，且不要求 crash 路径与原 input 相同，则立即报告 input 有效，该保留</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>exact_mode<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 是 non-crash mode，但现在 crash 了，说明这个 input 与原 input 路径不同，该丢弃</span>
      missed_crashes<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>crash_mode<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 发现目标程序没有 crash，而目前处于 crash mode，则本 input 与原 input 路径不同，该丢弃</span>
    missed_paths<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// 对 shm 计算 hash，注意这里的 shm 已经是 hit count 分桶处理之后的了</span>
  cksum <span class="token operator">=</span> <span class="token function">hash32</span><span class="token punctuation">(</span>trace_bits<span class="token punctuation">,</span> MAP_SIZE<span class="token punctuation">,</span> HASH_CONST<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>first_run<span class="token punctuation">)</span> orig_cksum <span class="token operator">=</span> cksum<span class="token punctuation">;</span>

  <span class="token comment">// 若本 input 的 shm hash 与原始 input 相同，则本 input 有效，予以保留</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>orig_cksum <span class="token operator">==</span> cksum<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>

  missed_paths<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>其中父进程创建了子进程，子进程执行目标程序，子进程执行完毕之后，父进程会读取子进程的 shm，并根据 shm 的内容 执行 <code>hit count机制</code> ，（shm 是 AFL 中用来记录程序执行过程中每个位置是否被触发了代码路径的，shm 的大小为 MAP_SIZE，MAP_SIZE 默认为 1M，每个字节代表一个位置，如果该位置被触发了代码路径，则该字节的值为 1，否则为 0） 判断本 input 是否有效，如果无效，则丢弃，如果有效，则保留。</p>
<h3 id="hit-count-分桶机制"><a href="#hit-count-分桶机制" class="headerlink" title="hit count 分桶机制"></a>hit count 分桶机制</h3><p>关键代码：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">classify_counts</span><span class="token punctuation">(</span>trace_bits<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">apply_mask</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span>trace_bits<span class="token punctuation">,</span> <span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span>mask_bitmap<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
cksum <span class="token operator">=</span> <span class="token function">hash32</span><span class="token punctuation">(</span>trace_bits<span class="token punctuation">,</span> MAP_SIZE<span class="token punctuation">,</span> HASH_CONST<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></figure>
<p>上述代码计算出了运行 hash。先看 classify_counts 函数，它负责将 shm 的 hit count 分桶处理，将 hit count 改为其所在的桶 id</p>
<p>AFL 设计了 8 个 hit count 桶，规则为输入走某个基本块的时候，如果命中的是 0、1、2、3、4-7、8-15、16-31、32-127、128+ 这些区间内，则认为是不同的命中，也就落入不同的桶内。</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Classify tuple counts. This is a slow &amp; naive version, but good enough here. */</span>

<span class="token keyword">static</span> <span class="token keyword">const</span> u8 count_class_lookup<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>

  <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>           <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>           <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>           <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>           <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">4</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">7</span><span class="token punctuation">]</span>     <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">8</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">15</span><span class="token punctuation">]</span>    <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">16</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">31</span><span class="token punctuation">]</span>   <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">32</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">127</span><span class="token punctuation">]</span>  <span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">128</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">255</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">128</span>

<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">classify_counts</span><span class="token punctuation">(</span>u8<span class="token operator">*</span> mem<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  u32 i <span class="token operator">=</span> MAP_SIZE<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>edges_only<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 若打开 -e 开关，则只要命中，无论命中多少次，都视为相同。</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>mem<span class="token punctuation">)</span> <span class="token operator">*</span>mem <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
      mem<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 将 hit count 改为其所在的桶 id</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token operator">*</span>mem <span class="token operator">=</span> count_class_lookup<span class="token punctuation">[</span><span class="token operator">*</span>mem<span class="token punctuation">]</span><span class="token punctuation">;</span>
      mem<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>接着算shm 的 消息摘要 （hash） 来表达它，有 <code>hash32</code> 函数完成。</p>
<h2 id="minimize"><a href="#minimize" class="headerlink" title="minimize"></a>minimize</h2><p>结构如下：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Actually minimize! */</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">minimize</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

next_pass<span class="token operator">:</span>
  <span class="token comment">// bblock deletion</span>
  
  <span class="token comment">// alphabet minimization</span>

  <span class="token comment">// character minimization</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>changed_any<span class="token punctuation">)</span> <span class="token keyword">goto</span> next_pass<span class="token punctuation">;</span>

finalize_all<span class="token operator">:</span>

  <span class="token comment">// 输出结果</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>minimize 最小化处理的手法：</p>
<ul>
<li>块归一化（Block Normalization）：首先，输入被划分为大约 128 个块（除了最后一个块外，块长度为 2 的幂次）, 尝试将输入数据中的非零块替换为全零，如果这样的更改不影响目标程序的行为，则应用这些更改。</li>
<li>块删除（Block Deletion）：首先将 input 分为 16 个块, 通过逐步减小删除块的大小来移除尽可能多的数据片段，只要这样做不会改变目标程序的行为。</li>
<li>字符集最小化（Alphabet Minimization）：减少输入中使用的不同字符   (共有 256 种) 的数量，用特定字符（如’0’）替代那些不影响程序行为的字符。</li>
<li>字符简化（Character Minimization）：从前往后扫描逐个检查每个字符，如果可以安全地将其替换为一个简单字符（如’0’），则进行替换。</li>
<li>重复上述步骤：直到没有进一步的变化为止，确保每次修改后的结果都能使文件更小或者更简单，但依然能够触发相同的程序行为。</li>
<li>最终统计与输出：计算并报告最小化过程对文件大小的影响、简化了多少字符以及执行了多少次测试。</li>
</ul>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p>非常感谢前人分析的优秀文章！这对我的学习帮助很大</p>
<section class="footnotes"><div class="footnote-list"><ol><li><span id="fn:1" class="footnote-text"><span><a target="_blank" rel="noopener" href="https://github.com/google/AFL">https://github.com/google/AFL</a>
<a href="#fnref:1" rev="footnote" class="footnote-backref"> ↩</a></span></span></li><li><span id="fn:2" class="footnote-text"><span><a target="_blank" rel="noopener" href="https://www.ruanx.net/afl-source-1/">https://www.ruanx.net/afl-source-1/</a>
<a href="#fnref:2" rev="footnote" class="footnote-backref"> ↩</a></span></span></li><li><span id="fn:3" class="footnote-text"><span><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-269534.htm">https://bbs.kanxue.com/thread-269534.htm</a>
<a href="#fnref:3" rev="footnote" class="footnote-backref"> ↩</a></span></span></li><li><span id="fn:4" class="footnote-text"><span><a target="_blank" rel="noopener" href="https://eternalsakura13.com/2020/08/23/afl/">https://eternalsakura13.com/2020/08/23/afl/</a>
<a href="#fnref:4" rev="footnote" class="footnote-backref"> ↩</a></span></span></li><li><span id="fn:5" class="footnote-text"><span><a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-265936.htm">https://bbs.pediy.com/thread-265936.htm</a>
<a href="#fnref:5" rev="footnote" class="footnote-backref"> ↩</a></span></span></li></ol></div></section>
                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/" class="category-chain-item">安全研究</a>
  
  
    <span>></span>
    
  <a href="/categories/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/Fuzz/" class="category-chain-item">Fuzz</a>
  
  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/" class="print-no-link">#安全研究</a>
      
        <a href="/tags/AFL/" class="print-no-link">#AFL</a>
      
        <a href="/tags/%E6%BA%90%E7%A0%81/" class="print-no-link">#源码</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>初窥 fuzz 门径：AFL源码研究</div>
      <div>https://k3ppf0r.github.io/2025/01/07/安全研究/Fuzz/初窥门径：AFL源码研究/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>k3ppf0r</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年1月7日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/03/01/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/Fuzz/%E5%90%83%E9%80%8F%E9%87%8D%E7%82%B9%EF%BC%9AAFL%E6%BA%90%E7%A0%81%E7%A0%94%E7%A9%B6%E4%BA%8C/" title="初窥 fuzz 门径：AFL源码研究二">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">初窥 fuzz 门径：AFL源码研究二</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/12/31/%E5%BF%83%E5%BE%97/CVE%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B/" title="个人提交开源系统CVE流程">
                        <span class="hidden-mobile">个人提交开源系统CVE流程</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="gitalk-container"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#gitalk-container', function() {
      Fluid.utils.createCssLink('/css/gitalk.css')
      Fluid.utils.createScript('https://lib.baomitu.com/gitalk/1.8.0/gitalk.min.js', function() {
        var options = Object.assign(
          {"clientID":"Ov23liMVKVOtuwYuvkw8","clientSecret":"9cb05e91f4572848c2255807ec06c72dcf447340","repo":"blog-gitalk-comments","owner":"k3ppf0r","admin":["k3ppf0r"],"language":"zh-CN","labels":["Gitalk"],"perPage":10,"pagerDirection":"last","distractionFreeMode":false,"createIssueManually":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token"},
          {
            id: '764da976cb25d05891220c9782fb6936'
          }
        )
        var gitalk = new Gitalk(options);
        gitalk.render('gitalk-container');
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    

  

</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script  src="https://lib.baomitu.com/prism/1.28.0/plugins/line-numbers/prism-line-numbers.min.js" ></script>

  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
