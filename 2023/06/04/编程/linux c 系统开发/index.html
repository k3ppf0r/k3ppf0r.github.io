

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/tab-about/red_bear.jpg">
  <link rel="icon" href="/img/tab-about/red_bear.jpg">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="k3ppf0r">
  <meta name="keywords" content="">
  
    <meta name="description" content="linux C 系统开发笔记">
<meta property="og:type" content="article">
<meta property="og:title" content="linux C 系统开发">
<meta property="og:url" content="https://k3ppf0r.github.io/2023/06/04/%E7%BC%96%E7%A8%8B/linux%20c%20%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91/index.html">
<meta property="og:site_name" content="k3ppf0r&#39;s blog">
<meta property="og:description" content="linux C 系统开发笔记">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://k3ppf0r.github.io/img/post-%E7%BC%96%E7%A8%8B/linux.jpg">
<meta property="article:published_time" content="2023-06-04T04:00:00.000Z">
<meta property="article:modified_time" content="2023-06-24T04:00:00.000Z">
<meta property="article:author" content="k3ppf0r">
<meta property="article:tag" content="linux">
<meta property="article:tag" content="C">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://k3ppf0r.github.io/img/post-%E7%BC%96%E7%A8%8B/linux.jpg">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>linux C 系统开发 - k3ppf0r&#39;s blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/prism/1.28.0/plugins/line-numbers/prism-line-numbers.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"k3ppf0r.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":2},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null},"gtag":null,"woyaola":null,"cnzz":null},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  



  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>k3ppf0r&#39;s blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/" target="_self">
                <i class="iconfont icon-link-fill"></i>
                <span>友链</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/0-post-default/post.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="linux C 系统开发"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-06-04 12:00" pubdate>
          2023年6月4日 中午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          5.6k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          48 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        

      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">linux C 系统开发</h1>
            
              <p id="updated-time" class="note note-info" style="">
                
                  
                    本文最后更新于 2023年6月24日 中午
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <blockquote>
<figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">        linux_c 系统开发学习笔记
                        -------k3ppf0r(qcw)
</code></pre></div></figure>
</blockquote>
<p>目前需要实现基于客户机和服务器 CS 模型的网络音频 广播&#x2F;点播 系统<br>本音频系统可以广泛用于在语言教室和公共广播等多种场所，该软件分为 CS，服务器运行在 PC 机器上，客户机可运行在 PC 或嵌入式，服务器以多播的方式向局域网中所有客户机发送数据，客户机可以根据自己的选择来决定要接收的数据。<br>服务器 &#x3D;》 路由器&#x2F;交换机 &#x3D;》 客户机 1，客户机 2，<br>类似 arp 协议？</p>
<p>参考书目：<br>UNIX 环境高级编程<br>UNIX 网络编程<br>TCP&#x2F;IP 详解<br>深入理解计算机系统</p>
<p>守护进程（系统日志）</p>
<p>S</p>
<p>多线程多进程开发(fork)</p>
<p>main data list</p>
<p>——–socket–&gt;</p>
<p>C<br>父进程 –&gt;(多进程实现及关系，进程间通信（管道，共享内存 ，消息队列）) 子进程（解析播放）<br>lib<br>引入数据库或者使用当前文件系统<br>解析文件系统存储<br>流量控制</p>
<p><strong>开始学不要谈效率问题 只要易读性,拿来主义</strong></p>
<h1 id="IO：-是实现一切的基础"><a href="#IO：-是实现一切的基础" class="headerlink" title="IO： 是实现一切的基础"></a>IO： 是实现一切的基础</h1><p>stdio 标准 IO<br>sysio 系统调用 IO,文件 IO,无缓存 IO<br>man 2 系统调用<br>man 7 查看机制</p>
<h2 id="标准-IO"><a href="#标准-IO" class="headerlink" title="标准 IO"></a>标准 IO</h2><p><strong>由标准 C 库（第三方库）提供的接口函数（通过封装操作系统提供的系统 IO，再给用户使用）</strong></p>
<p>man 3<br>FILE 类型贯穿始终（结构体）<br>fopen(); 内部 malloc(sizeof(FILE))<br>fclose(); 内部 free()<br>fgetc();<br>fputc();<br>fputs();<br>fgets();<br>&#x2F;&#x2F; 逐字节<br>fread();<br>fwrite();</p>
<p>const char *系列<br>是漏洞最多的地方;溢出在于%s;格式化字符串漏洞在于 format;</p>
<p>printf();<br>fprintf();<br>scanf();<br>sscanf(args…,format,str) &#x3D;&gt; 镜像函数 &lt;&#x3D; sprintf(str,format,args…) [itoa 等应用]</p>
<p>文件位置指针<br>重定位: fseek(fp,0L,SEEK_END);fseeko();<br>用于制造空洞文件<br>告诉我: ftell(fp);ftello();<br>倒回: rewind(fp);</p>
<p>fflush();<br>默认行缓冲模式，不加换行符，就会等着缓冲区满了输出。<br>写文件是全缓冲模式</p>
<p>getline();<br>getdelim();</p>
<p>临时文件 考虑到问题:1 如何不冲突 2 及时销毁<br>tmpnam();</p>
<p>FILE *tmpfile(void); &#x3D;&gt; 给你一个匿名文件</p>
<h2 id="系统层面-IO："><a href="#系统层面-IO：" class="headerlink" title="系统层面 IO："></a>系统层面 IO：</h2><p><strong>操作系统直接提供的接口函数</strong></p>
<p>文件描述符 fd 是在文件 IO 中贯穿始终的类型</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c">open<span class="token punctuation">,</span>close<span class="token punctuation">,</span>read<span class="token punctuation">,</span>write<span class="token punctuation">,</span> lseek
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p>(学习方法： 猜 FILE 内容 然后去验证)<br>FILE<br>| … |<br>| POS |<br>| FD |</p>
<p>文件描述符<br>就是一个数组下标，int 类型，通过整形数,找到文件结构体，再找到实际的文件<br>会优先使用当前最小的下标<br>|0|<br>|1|<br>|2|<br>打开同一个文件<br>|3|-&gt; struct1|…|pos|count|…| -&gt; inode1</p>
<p>|4|-&gt; struct2|…|pos|count|…| -&gt; inode1</p>
<p>一个结构体被引用到两个 fd<br>|5|-&gt; struct3|…|pos|count(记录被引用次数)|…| -&gt; inode2</p>
<p>|6|-&gt; struct3</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span>
<span class="token keyword">int</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>  变参实现
flags <span class="token operator">:</span> <span class="token function">O_NOATIME</span><span class="token punctuation">(</span>不去修改access time<span class="token punctuation">)</span>
O_NONBLOCK 非阻塞
r <span class="token operator">~</span> O_RDONLY
r<span class="token operator">+</span> <span class="token operator">~</span> O_RDWR
w <span class="token operator">~</span> O_WRONLY <span class="token operator">|</span> O_CREATE <span class="token operator">|</span> O_TRUNC
w<span class="token operator">+</span> <span class="token operator">~</span> O_RDWR <span class="token operator">|</span> O_CREATE <span class="token operator">|</span> O_TRUNC<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>将文件 IO 与标准 IO（FILE ）的区别<br>举例： 传达室老大爷跑邮局<br>标准 IO 是有缓存的，适用于吞吐量大，使用简单<br>文件 IO，无缓存 IO， 响应速度快，user_to_kernel</p>
<p>面试：如何使一个程序变快？ 使用文件 IO<br>提醒： 标准 IO 与文件 IO 不可混用<br>要转换： fileno() fdopen()</p>
<p>IO 的效率问题</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c">time <span class="token punctuation">.</span><span class="token operator">/</span>myps<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p>文件共享问题：多个任务共同操作一个文件或者协同完成任务<br>写程序删除一个文件的第十行<br>1、覆盖写<br>1-&gt; open r -&gt; fd1 -&gt; lseek 11<br>1-&gt; open r+ -&gt; fd2 -&gt; lseek 10<br>while()<br>{<br>1-&gt; fd1 -&gt; read<br>2-&gt; fd2 -&gt; write<br>}</p>
<p>2、truncate&#x2F;ftruncate</p>
<p>原子操作<br>不可分割的最小操作<br>作用： 解决竞争和冲突<br>如 tmpnam()</p>
<p>程序中的重定向：dup,dup2<br>对于 fd 拷贝一个副本，到当前可用的最小的下标去。只操作了文件描述符数组，内存中的文件指针不变。<br>close(1);<br>dup(fd); &#x2F;&#x2F; fd to 1<br>close(fd);<br>但如上方法有缺陷，不是原子操作<br>优化：<br>dup2(fd,1);<br>close(fd);<br>开发会注意到问题：<br>1 不要有内存泄漏<br>2 不要有写越界，溢出<br>3 不要当自己在写 main 函数，当自己在写一个小模块</p>
<p>同步问题 sync fsync fdatasync 中间层开发，介于底层和应用层<br>void sync(void);<br>将内核 buffer cache 全局催促</p>
<p>fcntl();<br>文件描述符所变的魔术，都来源于它</p>
<p>ioctl();<br>设备相关的管家<br>一切皆文件<br>光鲜亮丽下的祖安</p>
<p>&#x2F;dev&#x2F;fd&#x2F;目录<br>虚目录，显示的是当前进程的文件描述符信息<br>ls -l &#x2F;dev&#x2F;fd&#x2F;</p>
<p>&#x2F;*<strong>*******</strong>***<strong>*******</strong>**<strong>*******</strong>***<strong>*******</strong>&#x2F;</p>
<h1 id="文件系统："><a href="#文件系统：" class="headerlink" title="文件系统："></a>文件系统：</h1><p>类 ls 的实现,myls -l -a -i -n</p>
<h2 id="一、目录和文件"><a href="#一、目录和文件" class="headerlink" title="一、目录和文件"></a>一、目录和文件</h2><p>1.获取文件属性</p>
<blockquote>
<p>创建-开头的文件 指定路径；– 截断</p>
</blockquote>
<p>stat,fstat,lstat<br>（尤其小心使用数字常量，默认给的是 int）<br>（size 是一个属性而已，inode 才是唯一标识，block 是真实大小块）</p>
<p>2.文件访问权限</p>
<ul>
<li><p>st_mode 是一个 bitmap,表示文件类型，文件访问权限，特殊权限位</p>
<p>3.umask<br>0666 &amp; ~umask<br>防止产生权限过松的文件</p>
<p>4.文件权限的更改&#x2F;管理 chmod,fchmod<br>chmod(path,mode);<br>fchmod(fd,mode);</p>
<p>5.粘住位<br>t 位 <code>chmod 1777 /tmp</code><br>tmp 目录</p>
<p>6.文件系统 FAT UFS(类似 ext2)<br>文件系统 ： 文件或数据的存储和管理<br>FAT 16&#x2F;32 ：是一个静态（数组）单链表 Windows 不开源<br>{<br>int next[n];<br>char data[n][size];<br>}</p>
</li>
</ul>
<p>​ UFS<br>​ 柱面族&#x2F;块族<br>​ desc<br>​ inode 位图（0&#x2F;1 没用&#x2F;用）<br>​ 块位图<br>​ inode 节点(内部小格子一个 4K)<br>​ 块<br>​ inode 结构体数组<br>​ {<br>​ stat<br>​ 亚数据<br>​ 无关，隐藏<br>​ 15 指针 12 + 1 级间接块指针 2 （256）、3 （256 个 2 级指针）<br>​ }<br>​ 缺陷： inode 节点满了，但是块还是大量空白<br>​ 文件名在目录项，目录文件里</p>
<p>7.硬链接 符号链接<br>硬链接不能给目录、分区建立；反之符号链接可以<br>ln file file_link 硬链接是目录项的同义词,两个指针指向同一个数据块<br>ln -s file file_link<br>link();<br>unlink(); 弄出匿名文件<br>man 3 rm<br>remove();<br>man 2 mv<br>rename();</p>
<p>8.utime<br>可以更改文件最后读的时间和最后修改的时间</p>
<p>9.目录的创建和销毁<br>mkdir();<br>rmdir();</p>
<p>10.更改工作路径<br>man 2 cd<br>chdir(path);fchdir(fd);<br>可以突破 chroot();<br>getcwd(buf,BUFSIZE);&#x2F;&#x2F;pwd</p>
<p>11.分析目录，读取目录</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;glob.h></span></span>
<span class="token keyword">int</span> <span class="token function">glob</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pattern<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>errfunc<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>epath<span class="token punctuation">,</span> <span class="token keyword">int</span> eerrno<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">glob_t</span> <span class="token operator">*</span>pglob<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 释放glob函数调用的空间</span>
<span class="token keyword">void</span> <span class="token function">globfree</span><span class="token punctuation">(</span><span class="token class-name">glob_t</span> <span class="token operator">*</span>pglob<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>或者 API：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">opendir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">clsedir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">readdir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">rewinddir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">seekdir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">telldir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h2 id="二、-系统数据文件和信息"><a href="#二、-系统数据文件和信息" class="headerlink" title="二、 系统数据文件和信息"></a>二、 系统数据文件和信息</h2><p>&#x2F;etc&#x2F;passwd</p>
<p>&#x2F;etc&#x2F;group<br>getgrgid();<br>getgrgrnam();</p>
<p>&#x2F;etc&#x2F;shadow<br>格式： $加密方法$杂质串盐$hash<br>getspnam();<br>crypt();<br>getpass();</p>
<p>时间戳<br>time();<br>gmtime();<br>localtime();<br>mktime();<br>strfttime();</p>
<p>加解密:<br>hash 混淆,不可逆，如果原串相同，所得串也相同，防备撞库<br>x % 5 &#x3D; 2 &#x3D;&gt; x&#x3D;?<br>安全？ 攻击成本大于收益<br>加密-解密</p>
<h2 id="三、进程环境"><a href="#三、进程环境" class="headerlink" title="三、进程环境"></a>三、进程环境</h2><p>1、main 函数<br>int main(int argc,char **argv)<br>2、进程的终止<br>正常终止：<br>从 main 函数返回<br>调用 exit()<br>调用_exit() 或 _Exit() 程序被 pwn 了 避免故障扩大<br>最后一个线程从其启动例程返回<br>最后一个线程调用 pthread_exit<br>异常终止：<br>调用 abort<br>接到一个信号，并终止<br>最后一个线程对其取消请求做出响应。</p>
<figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">atexit(); 注册exit()的hook钩子函数(函数正文执行之前执行)
一个一个拿，一个一个放
应用(方便程序员的)： if(fd100 &lt; 0)&#123;
        close(fd1);
        close(fd2);
        ...
        close(fd99);
        perror();
        exit(1);
    &#125;
</code></pre></div></figure>
<p>3、命令行参数的分析<br>getopt();<br>getopt_long();</p>
<p>4、环境变量<br>key&#x3D;value<br><code>export</code> env<br>environ<br>getenv();<br>putenv();</p>
<p>5、C 程序的存储空间布局</p>
<p>32 位操作系统虚拟内存空间：<br>| 4G kernel |<br>| 3G 0xc0000000 |<br>| argv env |<br>| 栈 | 向下生长<br>| &#x2F;&#x2F;&#x2F; lib |<br>| heap | 向上生长<br>| bss |<br>|已初始化数据段 data|<br>| text 0x08048000|<br>| 0 |</p>
<p>pmap 查看 lib 映射</p>
<p>6、库</p>
<ul>
<li>动态库</li>
<li>静态库</li>
<li>手工装载库</li>
</ul>
<p>动态库的相关库函数</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//Link with -ldl.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;dlfcn.h></span></span>
<span class="token function">dlopen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">dlclose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_GNU_SOURCE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;dlfcn.h></span></span>
<span class="token function">dlmopen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>7、函数跳转</p>
<p>|c|<br>|b|<br>|a|<br>|main|</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">goto</span> label<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span>
label<span class="token operator">:</span> statement<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;setjmp.h></span></span>
<span class="token function">setjmp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">longjmp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>8、资源的获取以及控制</p>
<p>大部分 API 使用被封装在 ulimit 命令中</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/resource.h></span></span>
<span class="token function">getrlimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setrlimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h1 id="进程"><a href="#进程" class="headerlink" title="进程"></a>进程</h1><h2 id="进程基本知识"><a href="#进程基本知识" class="headerlink" title="进程基本知识"></a>进程基本知识</h2><p>1、进程标识符 pid</p>
<p>​ 类型 pid_t</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ps</span> aux
<span class="token function">ps</span> afx 显示父子关系
<span class="token function">ps</span> amx 更多信息
<span class="token function">ps</span> ax <span class="token parameter variable">-L</span>  线程信息<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>S 可中断的睡眠态</p>
<p>Z+ 僵尸进程，子进程结束，等待父进程收集，父进程还没有结束</p>
<p>孤儿进程</p>
<p>进程号是顺次向下使用</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;sys/types.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;unistd.h></span></span>
<span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>2、进程的产生 fork() vfork()(废弃)</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;unistd.h></span></span>
<span class="token class-name">pid_t</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//duplicating</span>

<span class="token comment">/*
	父进程 ------子进程
	...          ...
	fork();      exec();
	...          ...
	wait();

*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>注意理解关键字：duplicating 拷贝，克隆，一摸一样</p>
<p>父子进程的区别：fork()返回值不一样，pid 不同，ppid 也不同，未决信号和文件锁不继承，资源利用量清零。</p>
<p>init 进程：1 号，是所有进程的祖先进程</p>
<p>调度器的调度策略来决定哪一个进程先运行</p>
<p>在调用 fork() 前一定要刷新缓冲区流（文件全缓冲 终端行缓冲），这是因为全缓冲下父进程中 fork 前的输出也会被子进程复用。</p>
<p>子进程在循环中干完了规定的活后一定要退出，否则会继续 fork! 。</p>
<blockquote>
<p>1、fork()增加了读时共享，写时复制（Copy-On-Write，COW）的机制</p>
<p>写时复制可以避免拷贝大量根本就不会使用的数据（地址空间包含的数据多达数十兆）。</p>
<p>2、父子进程共用同一个文件描述符表（相当于公共设施的存在） ，这里也可以用来实现父子进程通信。</p>
</blockquote>
<p>3、进程的消亡及释放资源</p>
<p>wait 防止父进程已经结束，子进程还没结束，使得成为孤儿进程</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h></span></span>
<span class="token function">wait</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 一定阻塞 ~waitpid(-1,&amp;status,0);</span>
<span class="token function">waitpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 可以不阻塞</span>
<span class="token function">wait3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">wait4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>管理子进程，进程分配任务</p>
<p>1、分块法</p>
<p>2、交叉分配 √</p>
<p>3、池类算法</p>
<p>上游将任务送入任务池，下游抢任务，谁完成了就继续，涉及竞争冲突</p>
<p>4、exec 函数族</p>
<p>few &#x3D;&gt; 三剑客</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>

<span class="token comment">// exec() family  => replace</span>

<span class="token function">execl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 给文件名，会识别环境变量</span>
<span class="token function">execlp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">execle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">execv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 变参 好用</span>
<span class="token function">execvp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// exec之前 注意fflush(NULL)（也就是在fork前） ,刷新缓冲，写文件会是全缓冲。</span>
<span class="token comment">/*
后缀含义

l：以list形式传入参数
v：以vector形式传入参数
p：在$PATH中查找可执行程序
e：在envp[]中查找可执行程序

*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>内部命令和外部命令</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">type</span> <span class="token comment"># 判断是外部命令还是内部命令</span>
<span class="token function">which</span> <span class="token comment"># 查看命令所在的文件路径</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<p>70 行实现 mysh 执行外部命令</p>
<p>（命令分隔符都不能使用）</p>
<p>5、用户权限及组权限（u+s,g+s）</p>
<p>内核为每个进程维护的三个 UID 值（和三个 GID 值，是对应关系，略），这三个 UID 分别是：</p>
<p>RUID：(Real UID，实际用户 ID)，我们当前以哪个用户登录，我们运行程序产生进程的 RUID 就是这个用户的 UID。<br>EUID：(Effective UID，有效用户 ID)，指当前进程实际以哪个 UID 来运行。一般情况下 EUID 等于 RUID；但如果进程对应的可执行文件具有 SUID 权限（也就是 rws 的 s），那么进程的 EUID 是该文件属主的 UID，鉴权看的就是这个 ID。<br>SUID：(Saved Set-user-ID，保存的设置用户 ID)，EUID 的一个副本，与 SUID 权限有关。</p>
<p>文件和目录权限除了普通权限 rwx 外，还有三个特殊权限：</p>
<p>SUID：在属主的 x 位以 s 标识，全称 SetUID<br>SGID：在属组的 x 位以 s 标识，全称 SetGID<br>STIKCY：黏着位</p>
<p>exec 来鉴定权限， 设置 RUID EUID SUID , 执行文件进程鉴定权限 EUID （SUID）后，再继续执行</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">u+s/g+s 任何人在调用这个文件的时候，就会切换到
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p>init 进程（0，0，0） –fork,exec–&gt; getty 进程（0，0，0） –exec–&gt; login 进程（0，0，0） –checkpass–T–fork,exec–&gt;shell 进程（1001，1001，1001）</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-C" data-language="C"><code class="language-C">#include &lt;unistd.h&gt;
#include &lt;sys&#x2F;types.h&gt;

getuid();
geteuid();
getgid();
getegid();
&#x2F;&#x2F; effective
setuid();
setgid();
seteuid();
setegid();
&#x2F;&#x2F; 交换
setreuid();
setregid();<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>编写具有 u+s 的程序需要：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">chown</span> root mysu
<span class="token comment"># 权限下发</span>
<span class="token function">chmod</span> u+s mysu<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure>

<p>6、解释器文件</p>
<p>脚本文件</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token function">whoami</span>
<span class="token function">cat</span> /etc/shadow
<span class="token function">ls</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>shell 看到了#!，就会把解释器装载起来，再用你的解释器解释这个文件，此时会把第一句话当成注释。</p>
<blockquote>
<p>linux 世界讲究机制，而非策略</p>
</blockquote>
<p>7、system();</p>
<p>是 few 的简单封装。调用 shell 去执行命令。</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">system<span class="token punctuation">(</span><span class="token string">"date +%s"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment"># 等价于</span>
fork<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
execl<span class="token punctuation">(</span><span class="token string">"/bin/sh"</span>,<span class="token string">"sh"</span>,<span class="token string">"-c"</span>,<span class="token string">"date +%s"</span>,NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
wait<span class="token punctuation">(</span>NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>8、进程会计</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token function">acct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<p>9、进程时间</p>
<p>time 的实现</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;sys/times.h></span></span>
<span class="token function">times</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<p>10、守护进程 Daemon</p>
<p>会话 session 会话是有一个或者多个进程组组成的集合</p>
<p>通常，一个会话开始于用户登录，终止于用户退出，在此期间该用户运行的所有进程都属于这个会话</p>
<p>终端 （标准：只能输入和输出）tty</p>
<p>规范化 多线程并发</p>
<p>守护进程标志：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ps</span> ajx

<span class="token environment constant">PPID</span>   PID  PGID   SID   TTY
<span class="token number">1</span>	  same  same   same   ?<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token function">setsid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//只能子进程调用；父进程天生是进程组长</span>
<span class="token function">setpgid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//设置某个进程号到某个进程组</span>
<span class="token function">getpgrp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>单实例守护进程： 锁文件 &#x2F;var&#x2F;run&#x2F;name.pid</p>
<p>守护进程开机启动脚本文件：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">/etc/rc*

/etc/rc.d/rc.local<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure>

<p>11、系统日志</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> /var/log<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p>syslogd 服务</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;syslog.h></span></span>
<span class="token function">openlog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">syslog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">closelog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h2 id="并发"><a href="#并发" class="headerlink" title="并发"></a>并发</h2><blockquote>
<p>同步：按你所设想的步骤执行。</p>
<p>异步：例子：俄罗斯方块，事件什么时候到来不知道，什么时候出结果也不知道。</p>
<p>异步事件的处理：查询法（频繁）、通知法（稀疏）</p>
</blockquote>
<h3 id="一、信号"><a href="#一、信号" class="headerlink" title="一、信号"></a>一、信号</h3><p>1、信号是什么</p>
<p>信号是软件层面的中断。</p>
<p>信号的响应依赖于中断</p>
<p>中断是硬件层面的模仿</p>
<p>2、signal();</p>
<p>signal 会打断阻塞的系统调用</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h></span></span>

<span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token keyword">int</span>  signum<span class="token punctuation">,</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token operator">*</span>func<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//Ctrl-C 等于 sigint 终端中断符</span>
<span class="token function">signal</span><span class="token punctuation">(</span>SIGINT<span class="token punctuation">,</span>SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">signal</span><span class="token punctuation">(</span>SIGINT<span class="token punctuation">,</span>int_handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">signal</span><span class="token punctuation">(</span>SIGQUIT<span class="token punctuation">,</span>SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">signal</span><span class="token punctuation">(</span>SIGTERM<span class="token punctuation">,</span>SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 容易发生重入</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>3、信号的不可靠</p>
<p>信号的行为不可靠，有可能第一次执行还没结果，第二次就开始了。原因是信号的执行现场不是我们构建的。</p>
<p>4、可重入函数</p>
<p>所有的系统调用都是可重入的，一部分库函数也是可重入的，如：memcpy,rand_r</p>
<p>不可重入的函数不能用在信号处理中。</p>
<p>函数不可重入的条件</p>
<p>函数内使用了静态的数据。<br>函数内使用了 malloc 或者 free 函数<br>函数内调用了标准的 I&#x2F;O 函数</p>
<p>5、信号的响应过程</p>
<blockquote>
<p>内核只有一种概念:线程</p>
<p>信号从收到到响应有一个不可避免延迟：</p>
<p>（位图）</p>
<p>mask:11111111111111111（是否响应）</p>
<p>pending(来信号):0000000000001（置 1）</p>
<p>响应时：</p>
<p>（位图）</p>
<p>mask:1-&gt;0</p>
<p>pending:1-&gt;0</p>
<p>响应过程：</p>
<p>程序被打断，拿着中断现场进入内核，写入信号相关 mask 等，当从 kernel 态回到 user 态时，会做这样的行为 mask &amp; pending ，从而发现信号，执行信号注册的行为，行为执行完后回到内核，写入信号相关 mask 等，回到被打断的现场。</p>
</blockquote>
<figure><div class="code-wrapper"><pre class="line-numbers language-latex" data-language="latex"><code class="language-latex">如何忽略掉一个信号？
标准信号为什么要丢失
标准信号的响应没有严格的顺序。
不能从信号处理函数中随意的往外跳（setjmp,longjmp）<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>Linux 系统中的内核态本质是内核，是一种特殊的软件程序，用于控制计算机的硬件资源，例如协调 CPU 资源，分配内存资源，并且提供稳定的环境供应用程序运行。0-4G 范围的虚拟空间地址都可以操作，尤其是对 3-4G 范围的高位虚拟空间地址必须由内核态去操作。</p>
<p>用户态提供应用程序运行的空间，为了使应用程序访问到内核管理的资源，例如 CPU，内存，I&#x2F;O 等。用户态只能受限的访问内存，且不允许访问外设(硬盘、网卡等);内核态 CPU 可以访问内存所有数据，包括外设，且可以将自己从一个程序切换到另一个程序。</p>
<p>用户态切换到内核态的三种方式：</p>
<p>发生系统调用时：（主动）这是处于用户态的进程主动请求切换到内核态的一种方式。用户态的进程通过系统调用申请使用操作系统提供的系统调用服务例程来处理任务。而系统调用的机制，其核心仍是使用了操作系统为用户特别开发的一个中断机制来实现的，即软中断。<br>产生异常时：（被动）当 CPU 执行运行在用户态下的程序时，发生了某些事先不可知的异常，这时会触发由当前运行的进程切换到处理此异常的内核相关的程序中，也就是转到了内核态，如缺页异常。<br>外设产生中断时：（被动）当外围设备完成用户请求的操作后，会向 CPU 发出相应的中断信号，这时 CPU 会暂停执行下一条即将要执行的指令转而去执行与中断信号对应的处理程序，如果先前执行的指令是用户态下的程序，那么这个转换的过程自然也就发生了由用户态到内核态的切换。比如硬盘读写操作的完成，系统会切换到硬盘读写的中断处理程序中执行后续操作等。</p>
<p>6、信号常用函数</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h></span></span>
<span class="token function">kill</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 相当于</span>
<span class="token comment">// kill(getpid(),sig);</span>
<span class="token comment">// kill(pthread_kill(pthread_self(),sig));</span>
<span class="token function">raise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token function">alarm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">system</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//nanosleep();ulsleep();</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>7、信号集</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h></span></span>
<span class="token comment">//信号集类型 sigset_t</span>
<span class="token function">sigemptyset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">sigfillset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">sigaddset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">sigdelset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">sigismember</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>8、信号屏蔽字&#x2F;peding 集的处理</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h></span></span>

<span class="token function">sigprocmask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">sigpending</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//下内核</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>9、扩展</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h></span></span>
<span class="token function">sigsuspend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 原子化 比pause()高级</span>
<span class="token function">sigaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//原子化 优化signal 重入问题</span>

<span class="token comment">// 推荐： 代替 alarm(1);</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h></span></span>
<span class="token keyword">struct</span> <span class="token class-name">itimerval</span> itv<span class="token punctuation">;</span>
itv<span class="token punctuation">.</span>it_interval<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
itv<span class="token punctuation">.</span>it_interval<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
itv<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
itv<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token function">setitimer</span><span class="token punctuation">(</span>ITIMER_REAL<span class="token punctuation">,</span><span class="token operator">&amp;</span>itv<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>10、实时信号</p>
<p>取决于你用哪个信号，而不是哪套函数</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// min-max</span>
<span class="token comment">// 40 SIGRTMIN+6</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<h3 id="二、多线程实现"><a href="#二、多线程实现" class="headerlink" title="二、多线程实现"></a>二、多线程实现</h3><p>1、线程的概念</p>
<p>一个正在运行的函数</p>
<p>posix 线程是一套标准，而不是实现</p>
<p>openmp 线程</p>
<p>线程标识：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span>
<span class="token comment">//Compile and link with -pthread.</span>

<span class="token class-name">pthread_t</span><span class="token punctuation">;</span>
<span class="token function">pthread_equal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<blockquote>
<p>ps ax -L 查看</p>
</blockquote>
<p>2、线程的创建、终止、栈清理、取消选项</p>
<p>线程的调度取决于调度器策略。</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span>
<span class="token comment">//Compile and link with -pthread.</span>

<span class="token class-name">pthread_t</span> tid<span class="token punctuation">;</span>
<span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>func<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">pthread_join</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// wait()</span>

<span class="token comment">// hook 函数</span>
<span class="token function">pthread_cleanup_push</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">pthread_cleanup_pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 线程取消</span>
<span class="token function">pthread_cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>线程终止：1、线程从启动例程返回，返回值就是线程的退出码</p>
<p>2、线程可以被同一进程中的其它线程取消</p>
<p>3、线程调用 pthread_exit()函数</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// p 为返回值 => pthread_join(tid, &amp;p);</span>
<span class="token function">pthread_exit</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<p>线程取消：有两种状态，允许和不允许</p>
<p>允许取消又分为：异步 cancel，推迟 cancel-&gt;推迟至 cancel 点取消</p>
<p>cancel 点：POSIX 定义的 cancel 点，都是可能引发阻塞的系统调用</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">pthread_setcancelstate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// 设置是否允许取消</span>

<span class="token function">pthread_setcanceltype</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//设置取消方式</span>

<span class="token function">pthread_testcancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//取消点</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>线程分离：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">pthread_detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p>条件竞争：十字路口</p>
<p>用地址传参会导致竞争。</p>
<p>3、线程同步</p>
<p>互斥量</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span>
<span class="token class-name">pthread_mutex_t</span><span class="token punctuation">;</span>
<span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">pthread_mutex_destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">pthread_mutex_trylock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>条件变量：</p>
<p>先发通知再解锁</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">pthread_cond_t</span><span class="token punctuation">;</span>
<span class="token function">pthread_cond_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">pthread_cond_destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">pthread_cond_broadcast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">pthread_cond_signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">pthread_cond_wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>me<span class="token operator">-></span>cond<span class="token punctuation">,</span><span class="token operator">&amp;</span>me<span class="token operator">-></span>mut<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">pthread_cond_timewait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>信号量：</p>
<p>读写锁：互斥量和信号量的综合</p>
<p>r 读共享锁，w 写互斥锁（如果正在读，会加上预写锁）</p>
<p>4、线程属性，同步属性</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h></span></span>
<span class="token class-name">pthread_t</span> tid<span class="token punctuation">;</span>
<span class="token class-name">pthread_attr_t</span> attr<span class="token punctuation">;</span>
<span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">,</span><span class="token operator">&amp;</span>attr<span class="token punctuation">,</span>func<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">pthread_attr_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">pthread_attr_setstactsize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">pthreaed_attr_destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 见man pthread_attr_init 的see also</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>线程同步的属性：互斥量属性</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">pthread_mutexattr_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">pthread_mutexattr_destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">pthread_mutexattr_getpshared</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">pthread_mutexattr_setpshared</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_GNU_SOURCE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sched.h></span></span>
<span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 可以创建出既不是线程又不是进程的</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>条件变量属性：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">pthread_condattr_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">pthread_condattr_destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<p>读写锁属性：</p>
<p>5、重入</p>
<p>多线程中的 IO</p>
<p>线程与信号</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">pthread_sigmask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">sigwait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">pthread_kill</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure>

<p>重新做一套语言 天然支持并发</p>
<p>openmp 标准：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">omp parallel</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<h1 id="高级-IO"><a href="#高级-IO" class="headerlink" title="高级 IO"></a>高级 IO</h1><p>非阻塞 IO – 阻塞 IO</p>
<p>有限状态机编程</p>
<p>1、非阻塞 IO</p>
<p>简单流程：程序的自然流程（把大象放冰箱里）是结构化的</p>
<p>复杂流程：自然流程不是结构化的（网络协议、口令两次输入）而是一个复杂的流程图。</p>
<p>IO 密集型任务，大部分在空闲</p>
<p>2、IO 多路转接</p>
<p>监视任务</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/select.h></span></span>
<span class="token comment">// 可移植性非常好</span>
<span class="token comment">//select();</span>
<span class="token keyword">struct</span> <span class="token class-name">fsm_st</span> fsm12<span class="token punctuation">,</span> fsm21<span class="token punctuation">;</span>
fsm12<span class="token punctuation">.</span>state <span class="token operator">=</span> STATE_R<span class="token punctuation">;</span>
fsm12<span class="token punctuation">.</span>sfd <span class="token operator">=</span> fd1<span class="token punctuation">;</span>
fsm12<span class="token punctuation">.</span>dfd <span class="token operator">=</span> fd2<span class="token punctuation">;</span>

fsm21<span class="token punctuation">.</span>state <span class="token operator">=</span> STATE_R<span class="token punctuation">;</span>
fsm21<span class="token punctuation">.</span>sfd <span class="token operator">=</span> fd2<span class="token punctuation">;</span>
fsm21<span class="token punctuation">.</span>dfd <span class="token operator">=</span> fd1<span class="token punctuation">;</span>

fd_set rset<span class="token punctuation">,</span>wset<span class="token punctuation">;</span>
<span class="token keyword">while</span><span class="token punctuation">(</span>fsm12<span class="token punctuation">.</span>state <span class="token operator">!=</span> STATE_T <span class="token operator">||</span> fsm21<span class="token punctuation">.</span>state <span class="token operator">!=</span> STATE_T<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">//1、布置监视任务</span>
    <span class="token function">FD_ZERO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">FD_ZERO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fsm12<span class="token punctuation">.</span>state <span class="token operator">==</span> STATE_R<span class="token punctuation">)</span>
        <span class="token function">FD_SET</span><span class="token punctuation">(</span>fsm12<span class="token punctuation">.</span>sfd<span class="token punctuation">,</span><span class="token operator">&amp;</span>rset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fsm12<span class="token punctuation">.</span>state <span class="token operator">==</span> STATE_W<span class="token punctuation">)</span>
        <span class="token function">FD_SET</span><span class="token punctuation">(</span>fsm12<span class="token punctuation">.</span>dfd<span class="token punctuation">,</span><span class="token operator">&amp;</span>wset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fsm21<span class="token punctuation">.</span>state <span class="token operator">==</span> STATE_R<span class="token punctuation">)</span>
        <span class="token function">FD_SET</span><span class="token punctuation">(</span>fsm21<span class="token punctuation">.</span>sfd<span class="token punctuation">,</span><span class="token operator">&amp;</span>rset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fsm21<span class="token punctuation">.</span>state <span class="token operator">==</span> STATE_W<span class="token punctuation">)</span>
        <span class="token function">FD_SET</span><span class="token punctuation">(</span>fsm21<span class="token punctuation">.</span>dfd<span class="token punctuation">,</span><span class="token operator">&amp;</span>wset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//2、监视</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fsm12<span class="token punctuation">.</span>state <span class="token operator">&lt;</span> STATE_AUTO <span class="token operator">||</span> fsm21<span class="token punctuation">.</span>state <span class="token operator">&lt;</span> STATE_AUTO<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>fd1<span class="token punctuation">,</span>fd2<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>rset<span class="token punctuation">,</span><span class="token operator">&amp;</span>wset<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>errno <span class="token operator">==</span> EINTR<span class="token punctuation">)</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"select()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token comment">//3、查看监视结果</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">FD_ISSET</span><span class="token punctuation">(</span>fd1<span class="token punctuation">,</span><span class="token operator">&amp;</span>rset<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">FD_ISSET</span><span class="token punctuation">(</span>fd2<span class="token punctuation">,</span><span class="token operator">&amp;</span>wset<span class="token punctuation">)</span> <span class="token operator">||</span> fsm12<span class="token punctuation">.</span>state <span class="token operator">></span> STATE_AUTO<span class="token punctuation">)</span>
        <span class="token function">fsm_driver</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fsm12<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">FD_ISSET</span><span class="token punctuation">(</span>fd2<span class="token punctuation">,</span><span class="token operator">&amp;</span>rset<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">FD_ISSET</span><span class="token punctuation">(</span>fd1<span class="token punctuation">,</span><span class="token operator">&amp;</span>wset<span class="token punctuation">)</span> <span class="token operator">||</span> fsm21<span class="token punctuation">.</span>state <span class="token operator">></span> STATE_AUTO<span class="token punctuation">)</span>
        <span class="token function">fsm_driver</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fsm21<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>



<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;poll.h></span></span>
<span class="token comment">// 以文件描述符为单位来等待事件</span>
<span class="token comment">// poll();</span>
<span class="token keyword">struct</span> <span class="token class-name">pollfd</span> pfd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
pfd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> fd1<span class="token punctuation">;</span>
pfd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> fd2<span class="token punctuation">;</span>
<span class="token keyword">while</span><span class="token punctuation">(</span>fsm12<span class="token punctuation">.</span>state <span class="token operator">!=</span> STATE_T <span class="token operator">||</span> fsm21<span class="token punctuation">.</span>state <span class="token operator">!=</span> STATE_T<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">//布置监视任务</span>
    pfd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fsm12<span class="token punctuation">.</span>state <span class="token operator">==</span> STATE_R<span class="token punctuation">)</span>
        	pfd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">|=</span> POLLIN<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fsm21<span class="token punctuation">.</span>state <span class="token operator">==</span> STATE_W<span class="token punctuation">)</span>
        	pfd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">|=</span> POLLOUT<span class="token punctuation">;</span>
    pfd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fsm12<span class="token punctuation">.</span>state <span class="token operator">==</span> STATE_W<span class="token punctuation">)</span>
        	pfd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">|=</span> POLLOUT<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fsm21<span class="token punctuation">.</span>state <span class="token operator">==</span> STATE_R<span class="token punctuation">)</span>
        	pfd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">|=</span> POLLIN<span class="token punctuation">;</span>
    <span class="token comment">//监视</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fsm12<span class="token punctuation">.</span>state <span class="token operator">&lt;</span> STATE_AUTO <span class="token operator">||</span> fsm21<span class="token punctuation">.</span>state <span class="token operator">&lt;</span> STATE_AUTO<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">poll</span><span class="token punctuation">(</span>pfd<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>errno <span class="token operator">==</span> EINTR<span class="token punctuation">)</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"select()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//查看监视结果</span>
    <span class="token comment">// fd1 可读 或者 fd2 可写 =》 要么读1 要么写2</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>pfd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> POLLIN <span class="token operator">||</span> pfd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> POLLOUT <span class="token operator">||</span> fsm12<span class="token punctuation">.</span>state <span class="token operator">></span> STATE_AUTO<span class="token punctuation">)</span>
        <span class="token comment">// 数据中继引擎</span>
        <span class="token function">fsm_driver</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fsm12<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
	<span class="token comment">// fd2 可读 或者 fd1 可写</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>pfd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> POLLIN <span class="token operator">||</span> pfd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> POLLOUT <span class="token operator">||</span> fsm21<span class="token punctuation">.</span>state <span class="token operator">></span> STATE_AUTO<span class="token punctuation">)</span>
        <span class="token function">fsm_driver</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fsm21<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>poll 在 user 态建立了一个结构体数组，epoll 则是通过系统调用，kernel 来维护这个结构体数组</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h></span></span>
<span class="token comment">//epoll();</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<p>3、其他读写函数</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">readv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">writev</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">readn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">writen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>4、存储映射 IO</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h></span></span>
<span class="token keyword">int</span> fd<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">stat</span> statres<span class="token punctuation">;</span>
str <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span>statres<span class="token punctuation">.</span>st_size<span class="token punctuation">,</span>PROT_READ<span class="token punctuation">,</span>MAP_SHARED<span class="token punctuation">,</span>fd<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">munmap</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span>statres<span class="token punctuation">.</span>st_size<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>可以用来父子进程来共享内存</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MEMSIZE</span> <span class="token expression"><span class="token number">1024</span></span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">char</span><span class="token operator">*</span> ptr <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> MEMSIZE<span class="token punctuation">,</span> PROT_READ <span class="token operator">|</span> PROT_WRITE<span class="token punctuation">,</span> MAP_SHARED <span class="token operator">|</span> MAP_ANONYMOUS<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ptr <span class="token operator">==</span> MAP_FAILED<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mmap()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">int</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">munmap</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> MEMSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// child</span>
    <span class="token punctuation">&#123;</span>
        <span class="token function">strcpy</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> <span class="token string">"hello!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">munmap</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> MEMSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span> <span class="token comment">// parent</span>
        <span class="token function">wait</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">puts</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">munmap</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> MEMSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>5、文件锁</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>

<span class="token function">fcntl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

FILE <span class="token operator">*</span>fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
fd <span class="token operator">=</span> <span class="token function">fileno</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">lockf</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>F_LOCK<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* ... */</span>
<span class="token function">fflush</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">lockf</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>F_ULOCK<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">flock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E7%BC%96%E7%A8%8B/" class="category-chain-item">编程</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/linux/" class="print-no-link">#linux</a>
      
        <a href="/tags/C/" class="print-no-link">#C</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>linux C 系统开发</div>
      <div>https://k3ppf0r.github.io/2023/06/04/编程/linux c 系统开发/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>k3ppf0r</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年6月4日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/09/17/%E5%BF%83%E5%BE%97/%E5%86%99%E7%BB%99%E8%87%AA%E5%B7%B1%EF%BC%9A2024%E5%B9%B4%E6%88%91%E7%9A%84%E8%81%8C%E4%B8%9A%E8%A7%84%E5%88%92/" title="写给自己：2024年我的职业规划">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">写给自己：2024年我的职业规划</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/03/04/IOT%E5%AE%89%E5%85%A8/IOT%E6%A0%88%E6%BA%A2%E5%87%BA/" title="IOT栈溢出常见漏洞函数">
                        <span class="hidden-mobile">IOT栈溢出常见漏洞函数</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            

          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    

  

</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script  src="https://lib.baomitu.com/prism/1.28.0/plugins/line-numbers/prism-line-numbers.min.js" ></script>

  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
